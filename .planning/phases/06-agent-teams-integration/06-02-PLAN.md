---
phase: 06-agent-teams-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/mz-executor.md
  - agents/mz-reviewer.md
autonomous: true
requirements:
  - AGNT-04
  - AGNT-06

must_haves:
  truths:
    - "Executor agent can operate in two modes: subagent mode (Phase 4/5 behavior) and teammate mode (Agent Teams with worktree isolation)"
    - "Reviewer agent can send structured feedback to a specific implementer via SendMessage and re-review after fixes"
    - "Executor agent in teammate mode works within a git worktree, respects file ownership, and communicates via SendMessage"
  artifacts:
    - path: "agents/mz-executor.md"
      provides: "Executor agent with dual-mode support (subagent and teammate)"
      contains: "Teammate Mode"
    - path: "agents/mz-reviewer.md"
      provides: "Reviewer agent with SendMessage feedback protocol for Agent Teams"
      contains: "SendMessage"
  key_links:
    - from: "agents/mz-executor.md"
      to: "skills/go/SKILL.md"
      via: "executor receives mode indicator in execution_rules"
      pattern: "execution_mode.*subagent|teammate"
    - from: "agents/mz-reviewer.md"
      to: "agents/mz-executor.md"
      via: "reviewer sends SendMessage to executor's agent name"
      pattern: "SendMessage.*recipient.*exec-"
---

<objective>
Update executor and reviewer agent definitions for dual-mode operation: existing subagent mode (unchanged) and new Agent Teams teammate mode with worktree context, file ownership awareness, and SendMessage communication.

Purpose: Agent definitions are the reusable prompt components embedded in Task calls. The executor needs to understand worktree isolation and teammate communication. The reviewer needs SendMessage feedback loops instead of nested return values.

Output: Updated agents/mz-executor.md and agents/mz-reviewer.md with backward-compatible dual-mode support.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-teams-integration/06-RESEARCH.md
@.planning/phases/06-agent-teams-integration/06-CONTEXT.md
@agents/mz-executor.md
@agents/mz-reviewer.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update executor agent for dual-mode operation (subagent + teammate)</name>
  <files>agents/mz-executor.md</files>
  <action>
Modify `agents/mz-executor.md` to support both subagent mode (existing, unchanged) and teammate mode (Agent Teams). The entire existing content remains valid for subagent mode. Add the teammate mode as an additive section that activates based on `execution_rules`.

**Add a "## Mode Detection" section** after the existing "## Input" section:

Explain that the executor checks `<execution_rules>` for `execution_mode`:
- If `execution_mode: subagent` (or absent): follow the existing execution flow exactly as documented below. This is the Phase 4/5 behavior.
- If `execution_mode: teammate`: follow the Teammate Mode Protocol section instead of the standard flow.

**Add a "## Teammate Mode Protocol" section** after the existing "## Completion" section. This section covers:

**1. Worktree Awareness:**
- The executor's working directory is a git worktree at the path specified in `<execution_rules>` field `worktree_path`.
- First action: run `cd {worktree_path}` to ensure all operations happen in the worktree.
- All file paths in the plan are relative to the project root. Since the worktree IS a full checkout, paths work as-is.
- The executor commits to the worktree's branch (already checked out by the worktree creation).

**2. File Ownership:**
- The executor's declared file scope is listed in `<execution_rules>` field `owned_files`.
- The executor SHOULD only modify files in its declared scope.
- If a file outside the scope must be modified (deviation), log it as a deviation in the SUMMARY.md under "File Ownership Deviations."
- A PreToolUse hook may enforce ownership (advisory or hard block depending on config).

**3. Communication via SendMessage:**
- In teammate mode, the executor is a teammate in an Agent Teams team.
- Use `SendMessage({ type: "message", recipient: "{team_lead_name}", content: "...", summary: "..." })` to report progress, ask questions, or escalate issues.
- The team lead name is provided in `<execution_rules>` field `team_lead`.
- When a task is complete and review is enabled, notify the reviewer: `SendMessage({ type: "message", recipient: "{reviewer_name}", content: "Task {N} complete. Commit: {hash}. Ready for review.", summary: "Task {N} ready for review" })`.
- When receiving review feedback from the reviewer (via incoming message), fix the identified issues and re-commit (amend). Then notify the reviewer: `SendMessage({ type: "message", recipient: "{reviewer_name}", content: "Fixed findings. Re-committed.", summary: "Fixes applied, re-review requested" })`.

**4. Task Lifecycle (Agent Teams):**
- On start: claim the task via `TaskUpdate({ taskId: "{task_id}", status: "in_progress" })` (task_id from execution_rules).
- On completion: mark the task via `TaskUpdate({ taskId: "{task_id}", status: "completed" })`.
- Create SUMMARY.md as normal (same format as subagent mode).

**5. Differences from Subagent Mode:**
- Communication is via SendMessage (not return value to orchestrator)
- Working directory is a worktree (not the main repo)
- Task lifecycle managed via TaskUpdate (not implicit return)
- File ownership is enforced (advisory or hard)
- Commit format is the same (conventional commits, no Co-Authored-By)

Keep the existing sections ("## Your Objective", "## Input", "## Execution Flow", etc.) completely unchanged. They continue to describe subagent mode. The teammate mode section is additive.
  </action>
  <verify>
Verify the updated file contains both modes:
```bash
grep -c "Subagent" agents/mz-executor.md       # Expect 1+
grep -c "Teammate Mode" agents/mz-executor.md   # Expect 1+
grep -c "SendMessage" agents/mz-executor.md      # Expect 1+
grep -c "worktree_path" agents/mz-executor.md    # Expect 1+
grep -c "TaskUpdate" agents/mz-executor.md       # Expect 1+
wc -l agents/mz-executor.md                      # Should be ~450-500 lines (was ~356)
```
  </verify>
  <done>Executor agent supports both subagent mode (unchanged Phase 4/5 behavior) and teammate mode (worktree awareness, file ownership, SendMessage communication, TaskUpdate lifecycle). Mode is determined by execution_mode in execution_rules.</done>
</task>

<task type="auto">
  <name>Task 2: Update reviewer agent for Agent Teams SendMessage feedback protocol</name>
  <files>agents/mz-reviewer.md</files>
  <action>
Modify `agents/mz-reviewer.md` to add Agent Teams teammate mode alongside the existing subagent mode. Existing content remains unchanged for subagent mode.

**Add a "## Mode Detection" section** after the existing input section:

- If `review_mode_type: subagent` (or absent in execution_rules): follow existing two-stage review flow, write report to disk, return structured result. This is the Phase 5 behavior.
- If `review_mode_type: teammate`: follow the Teammate Review Protocol below.

**Add a "## Teammate Review Protocol" section** after the existing output section:

**1. Review Trigger:**
- The reviewer is a teammate in an Agent Teams team.
- Review is triggered by a SendMessage from an implementer: "Task {N} complete. Commit: {hash}. Ready for review."
- The reviewer reads the implementer's work from the implementer's worktree (path provided in the message or in execution_rules field `worktree_paths`).

**2. Hybrid Review Model (per user decision):**

**Minor issues** (typo, formatting, simple style -- issues the reviewer can describe a fix for in < 5 lines):
- Note the fix in the review message to the team lead.
- The lead or implementer applies the fix.
- Rationale: Reviewer does NOT directly modify the implementer's worktree (preserves isolation).

**Structural/logical problems:**
- Send feedback to the IMPLEMENTER directly via SendMessage:
  ```
  SendMessage({
    type: "message",
    recipient: "{implementer_name}",
    content: "## Review: Task {N}\n\n### Critical\n1. [file:line] {issue}\n   Fix: {suggestion}\n\n### Minor (will note for lead)\n- {minor item}\n\nPlease fix critical findings and re-commit.",
    summary: "Review: {count} critical findings for Task {N}"
  })
  ```
- Wait for the implementer's fix message.
- Re-review: check ONLY the changes since last review (delta review, not full re-review).

**3. Review Rounds:**
- Max 3 total rounds (initial + 2 re-reviews), matching Phase 5 baseline.
- Round tracking: the reviewer counts rounds per task internally.
- On max rounds exceeded: send final summary to the team lead:
  ```
  SendMessage({
    type: "message",
    recipient: "{team_lead}",
    content: "## Escalation: Task {N}\n\nMax review rounds reached. Unresolved:\n{findings}\n\nRecommendation: proceed with known issues.",
    summary: "Escalation: unresolved findings after 3 rounds"
  })
  ```

**4. Completion:**
- After all assigned reviews pass (or escalate): notify the team lead:
  ```
  SendMessage({
    type: "message",
    recipient: "{team_lead}",
    content: "All reviews complete for {plan}. {passed}/{total} tasks passed review.",
    summary: "Reviews complete: {passed}/{total} passed"
  })
  ```

**5. Write Review Report:**
- Still write the review report to disk (same format as subagent mode) for audit trail.
- Location: in the phase directory, same path convention.

Keep the existing two-stage review description, severity levels, and report format completely unchanged. They apply to both modes. The teammate protocol section is additive.
  </action>
  <verify>
Verify the updated file:
```bash
grep -c "SendMessage" agents/mz-reviewer.md        # Expect 3+
grep -c "Teammate Review Protocol" agents/mz-reviewer.md  # Expect 1
grep -c "Hybrid Review Model" agents/mz-reviewer.md       # Expect 1
grep -c "Escalation" agents/mz-reviewer.md                # Expect 1+
grep -c "subagent" agents/mz-reviewer.md                  # Expect 1+
wc -l agents/mz-reviewer.md                               # Should be ~280-320 lines (was ~173)
```
  </verify>
  <done>Reviewer agent supports both subagent mode (unchanged Phase 5 behavior) and teammate mode (SendMessage feedback to implementer, hybrid review model with minor/structural split, 3-round max with escalation to lead, delta re-review). Both modes write review reports to disk.</done>
</task>

</tasks>

<verification>
- agents/mz-executor.md contains Teammate Mode section with worktree awareness, file ownership, SendMessage, TaskUpdate lifecycle
- agents/mz-reviewer.md contains Teammate Review Protocol with SendMessage feedback, hybrid review model, 3-round escalation
- Both agents retain full backward compatibility (subagent mode is unchanged, activated when execution_mode is absent)
- No new file dependencies (both are markdown agent definitions)
</verification>

<success_criteria>
Executor and reviewer agent definitions support dual-mode operation. Subagent mode (Phase 4/5) is unchanged. Teammate mode adds worktree isolation, file ownership awareness, SendMessage communication, and TaskUpdate lifecycle for Agent Teams integration.
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-teams-integration/06-02-SUMMARY.md`
</output>
