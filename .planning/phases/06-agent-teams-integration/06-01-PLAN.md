---
phase: 06-agent-teams-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/worktree.ts
  - src/lib/ownership.ts
  - src/lib/config.ts
  - src/cli/commands/worktree-tools.ts
autonomous: true
requirements:
  - AGNT-05
  - AGNT-07

must_haves:
  truths:
    - "Git worktrees can be created, listed, merged, and pruned per team/agent via CLI commands"
    - "File ownership manifests can be generated from plan frontmatter and validated against file paths"
    - "Config schema includes agent_teams section with enabled and worktree_dir fields"
  artifacts:
    - path: "src/lib/worktree.ts"
      provides: "Git worktree lifecycle management (create, remove, merge, list, prune)"
      exports: ["createWorktree", "removeWorktree", "mergeWorktree", "listTeamWorktrees", "pruneTeamWorktrees", "WorktreeInfo"]
    - path: "src/lib/ownership.ts"
      provides: "File ownership manifest generation and validation"
      exports: ["generateOwnershipManifest", "validateFileAccess", "OwnershipManifest"]
    - path: "src/lib/config.ts"
      provides: "Extended config schema with agent_teams section"
      contains: "agentTeamsSchema"
    - path: "src/cli/commands/worktree-tools.ts"
      provides: "CLI subcommands for worktree operations"
      exports: ["registerWorktreeCommands"]
  key_links:
    - from: "src/cli/commands/worktree-tools.ts"
      to: "src/lib/worktree.ts"
      via: "import and invoke worktree functions"
      pattern: "import.*from.*worktree"
    - from: "src/lib/ownership.ts"
      to: "src/lib/plan.ts"
      via: "reads PlanMetadata.files_modified to build manifest"
      pattern: "files_modified"
---

<objective>
Create the TypeScript infrastructure for git worktree isolation and file ownership enforcement.

Purpose: Worktree management ensures each parallel agent works in a completely isolated git checkout, preventing file conflicts. File ownership enforcement ensures agents only modify files within their declared scope. Config extension enables user control over Agent Teams behavior.

Output: Four new/modified TypeScript modules providing worktree lifecycle, ownership validation, config schema, and CLI tooling.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-teams-integration/06-RESEARCH.md
@src/lib/plan.ts
@src/lib/config.ts
@src/cli/commands/worktree-tools.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create worktree management library and ownership validation module</name>
  <files>
    src/lib/worktree.ts
    src/lib/ownership.ts
  </files>
  <action>
Create `src/lib/worktree.ts` with the following exports. Use `execSync` from `node:child_process`, `join` from `node:path`, `homedir` from `node:os`, and `fse` from `fs-extra` (default import, matching existing pattern in config.ts).

**WorktreeInfo interface:**
- `path: string` (absolute worktree directory path)
- `branch: string` (branch name, format: `mz/{team}/{agent}`)
- `agent: string` (agent identifier)
- `team: string` (team name)

**getWorktreeBase(configDir?: string): string** -- Returns `configDir` if provided, otherwise `~/.megazord/worktrees` (using `homedir()`).

**createWorktree(team, agent, baseRef = "HEAD", baseDir?): WorktreeInfo** -- Constructs path as `{base}/{team}/{agent}`, branch as `mz/{team}/{agent}`. Ensures team directory exists via `fse.ensureDirSync`. Runs `git worktree add "{path}" -b "{branch}" {baseRef}`. Returns WorktreeInfo. Throws descriptive error on failure (wrap in try/catch, rethrow with context: "Failed to create worktree for {agent} in team {team}: {original error}").

**removeWorktree(team, agent, baseDir?): void** -- Runs `git worktree remove "{path}" --force`, then `git branch -D "{branch}"`. Both wrapped in try/catch (silently ignore if already removed).

**mergeWorktree(team, agent, strategy = "merge"): { success: boolean; conflicts: boolean; message: string }** -- Constructs branch name. If strategy is "merge": runs `git merge {branch} --no-ff -m "merge({team}): merge {agent} work"`. If strategy is "rebase": runs `git rebase {branch}`. Returns success/conflicts/message object. On error, checks if message includes "CONFLICT" to set conflicts flag.

**listTeamWorktrees(team): WorktreeInfo[]** -- Runs `git worktree list --porcelain`. Parses output splitting on double-newline. For each entry, extracts branch from `branch refs/heads/` line and path from `worktree ` line. Filters to branches starting with `mz/{team}/`. Returns array of WorktreeInfo.

**pruneTeamWorktrees(team, baseDir?): void** -- Lists all agent directories in `{base}/{team}/`. For each, calls `removeWorktree`. Then removes team directory via `fse.removeSync`. Finally runs `git worktree prune`.

All `execSync` calls use `{ encoding: "utf-8", stdio: "pipe" }` to capture output and suppress terminal noise.

Create `src/lib/ownership.ts` with the following exports. Import `PlanFile` from `./plan.ts` and `fse` from `fs-extra`.

**OwnershipManifest type:** `Record<string, string[]>` -- Maps agent name to list of file paths.

**generateOwnershipManifest(plans: PlanFile[], agentPrefix = "exec"): OwnershipManifest** -- For each plan, creates an entry with key `{agentPrefix}-{plan.metadata.plan}` (using the padded plan number) and value `plan.metadata.files_modified`. Returns the manifest object.

**writeOwnershipManifest(manifest: OwnershipManifest, outputPath: string): void** -- Writes manifest as JSON with 2-space indent via `fse.writeJsonSync`.

**validateFileAccess(manifest: OwnershipManifest, agentName: string, filePath: string): { allowed: boolean; reason: string }** -- Looks up `manifest[agentName]`. If agent not in manifest, returns `{ allowed: true, reason: "Agent not in manifest (unrestricted)" }`. If agent's file list is empty, returns `{ allowed: true, reason: "Agent has no file restrictions" }`. Otherwise checks if `filePath` starts with any entry in the agent's file list (prefix match for directory-level ownership). If match found: `{ allowed: true, reason: "File within declared scope" }`. If no match: `{ allowed: false, reason: "File '{filePath}' outside declared scope. Allowed: {list}" }`.
  </action>
  <verify>
Run `bun run build` to verify TypeScript compilation succeeds. Verify both files exist and export the expected functions:
```bash
grep -c "export function" src/lib/worktree.ts  # Expect 6
grep -c "export function" src/lib/ownership.ts  # Expect 3
grep -c "export.*interface\|export.*type" src/lib/worktree.ts  # Expect 1+ (WorktreeInfo)
grep -c "export.*type" src/lib/ownership.ts  # Expect 1+ (OwnershipManifest)
```
  </verify>
  <done>worktree.ts exports 6 functions (createWorktree, removeWorktree, mergeWorktree, listTeamWorktrees, pruneTeamWorktrees, getWorktreeBase) and WorktreeInfo interface. ownership.ts exports 3 functions (generateOwnershipManifest, writeOwnershipManifest, validateFileAccess) and OwnershipManifest type. Both compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Extend config schema and create worktree CLI commands</name>
  <files>
    src/lib/config.ts
    src/cli/commands/worktree-tools.ts
  </files>
  <action>
**Modify `src/lib/config.ts`:**

Add a new sub-schema AFTER the existing `workflowSchema`:

```typescript
/** Agent Teams coordination settings */
export const agentTeamsSchema = z.object({
  enabled: z.enum(["auto", "always", "never"]).default("auto"),
  worktree_dir: z.string().optional(),
  strict_ownership: z.boolean().default(false),
});
```

Add `agent_teams` field to `configSchema` AFTER the `workflow` field:

```typescript
/** Agent Teams coordination settings */
agent_teams: agentTeamsSchema.default({
  enabled: "auto",
  strict_ownership: false,
}),
```

Update all three presets to include `agent_teams`:
- `strict`: `{ enabled: "auto", strict_ownership: true }` (strict preset enables hard ownership)
- `balanced`: `{ enabled: "auto", strict_ownership: false }`
- `minimal`: `{ enabled: "never", strict_ownership: false }` (minimal disables Agent Teams)

**Create `src/cli/commands/worktree-tools.ts`:**

Follow the exact registration pattern from existing command files (registerStateCommands, registerPlanCommands). Import from `commander` and from `../lib/worktree.ts`.

Export `registerWorktreeCommands(parent: Command)` function that creates a `worktree` subcommand group under `tools`:

1. `worktree create --team <team> --agent <agent> [--base-ref <ref>] [--base-dir <dir>]` -- Calls `createWorktree`, outputs JSON result.
2. `worktree list --team <team>` -- Calls `listTeamWorktrees`, outputs JSON array.
3. `worktree merge --team <team> --agent <agent> [--strategy <merge|rebase>]` -- Calls `mergeWorktree`, outputs JSON result.
4. `worktree remove --team <team> --agent <agent> [--base-dir <dir>]` -- Calls `removeWorktree`, outputs `{ removed: true }`.
5. `worktree prune --team <team> [--base-dir <dir>]` -- Calls `pruneTeamWorktrees`, outputs `{ pruned: true }`.

Each command wraps its body in try/catch, outputting `{ error: message }` on failure. All output via `console.log(JSON.stringify(result, null, 2))` matching existing CLI patterns.

**Register the new commands** in the CLI entry point. Find the file where `registerPlanCommands` and `registerStateCommands` are called (likely `src/cli/index.ts` or similar) and add `registerWorktreeCommands(toolsGroup)` alongside them. Import from `./commands/worktree-tools.js`.
  </action>
  <verify>
Run `bun run build` to verify compilation. Then test the CLI registration:
```bash
node bin/megazord.mjs tools worktree --help
```
Expect to see create, list, merge, remove, prune subcommands listed.

Verify config schema change:
```bash
node -e "const { configSchema } = require('./bin/megazord.mjs'); console.log('has agent_teams:', 'agent_teams' in configSchema.shape)"
```
Or simply check the source for the agent_teams field.
  </verify>
  <done>Config schema includes agent_teams section with enabled/worktree_dir/strict_ownership fields. All three presets include agent_teams. CLI `tools worktree` group is registered with 5 subcommands (create, list, merge, remove, prune). Build succeeds.</done>
</task>

</tasks>

<verification>
- `bun run build` compiles all TypeScript without errors
- `node bin/megazord.mjs tools worktree --help` shows 5 subcommands
- `src/lib/worktree.ts` exports 6 functions + WorktreeInfo
- `src/lib/ownership.ts` exports 3 functions + OwnershipManifest
- `src/lib/config.ts` contains agentTeamsSchema with enabled/worktree_dir/strict_ownership
- All presets include agent_teams section
</verification>

<success_criteria>
Git worktree lifecycle management and file ownership validation are available as TypeScript libraries and CLI tools. Config schema supports Agent Teams settings. All code compiles and CLI commands are discoverable.
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-teams-integration/06-01-SUMMARY.md`
</output>
