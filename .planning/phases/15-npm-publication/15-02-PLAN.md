---
phase: 15-npm-publication
plan: 02
type: execute
wave: 2
depends_on: [15-01]
files_modified: [src/cli/commands/install.ts, src/cli/commands/update.ts, src/cli/commands/uninstall.ts, src/cli/utils/detect-plugins.ts, src/cli/utils/update-check.ts, commands/update.md]
autonomous: true
requirements: [NPM-02]

must_haves:
  truths:
    - "Install copies all plugin dirs to ~/.claude/megazord/ with no prompts"
    - "Install writes .version file with current version"
    - "Install registers plugin with Claude Code marketplace system"
    - "On install failure, partial state is fully rolled back"
    - "Update overwrites ~/.claude/megazord/ with latest files"
    - "Uninstall removes ~/.claude/megazord/ and deregisters from Claude Code"
    - "Output is minimal — single result line per operation"
    - "Automatic update check queries npm registry and writes .update-check file"
    - "/mz:update command skill exists and delegates to megazord-cli update"
  artifacts:
    - path: "src/cli/commands/install.ts"
      provides: "Silent install to ~/.claude/megazord/ with rollback"
      min_lines: 80
    - path: "src/cli/commands/update.ts"
      provides: "Overwrite ~/.claude/megazord/ with latest version"
      min_lines: 40
    - path: "src/cli/commands/uninstall.ts"
      provides: "Full cleanup of ~/.claude/megazord/ and registry entries"
      min_lines: 40
    - path: "src/cli/utils/detect-plugins.ts"
      provides: "Detection checks ~/.claude/megazord/ exists"
    - path: "src/cli/utils/update-check.ts"
      provides: "npm registry check, writes .update-check with latest version"
      min_lines: 30
    - path: "commands/update.md"
      provides: "/mz:update skill that delegates to megazord-cli update"
  key_links:
    - from: "src/cli/commands/install.ts"
      to: "src/lib/paths.ts"
      via: "import megazordDir"
      pattern: "import.*megazordDir.*paths"
    - from: "src/cli/commands/install.ts"
      to: "~/.claude/megazord/"
      via: "copyDirSync to megazordDir"
      pattern: "megazordDir"
    - from: "src/cli/commands/uninstall.ts"
      to: "~/.claude/megazord/"
      via: "rmSync on megazordDir"
      pattern: "rmSync.*megazordDir"
    - from: "src/cli/utils/update-check.ts"
      to: "src/lib/paths.ts"
      via: "import megazordUpdateCheckPath"
      pattern: "import.*megazordUpdateCheckPath.*paths"
    - from: "commands/update.md"
      to: "megazord-cli update"
      via: "Bash command delegation"
      pattern: "megazord-cli update"
---

<objective>
Refactor install, update, and uninstall commands for `~/.claude/megazord/` file placement with silent mode and rollback.

Purpose: NPM-02 requires `bunx megazord-cli install` to work on a clean machine. The current install uses the plugin cache path and has interactive prompts. Per user decisions: silent install (no prompts), dedicated `~/.claude/megazord/` directory, immutable files, atomic install with rollback on failure, minimal output, automatic update check, and dual update channels (CLI + `/mz:update` skill).
Output: Refactored install/update/uninstall commands, update check utility, and /mz:update command skill
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-npm-publication/15-RESEARCH.md
@.planning/phases/15-npm-publication/15-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor install.ts for silent install to ~/.claude/megazord/</name>
  <files>src/cli/commands/install.ts, src/cli/utils/detect-plugins.ts</files>
  <action>
**Rewrite `src/cli/commands/install.ts` completely.** The current code has interactive prompts, uses plugin cache paths, and is missing several directories from the copy list. The new version must:

1. **Remove ALL interactive prompts** — delete `confirm()`, `selectOption()`, `createInterface` import. No `--yes` flag check. The install is always silent (CONTEXT locked decision).

2. **Use `~/.claude/megazord/` as target** — import `megazordDir`, `megazordVersionPath` from `../../lib/paths.js`. All plugin files go here.

3. **Copy ALL required directories** — the copy list MUST be: `.claude-plugin`, `hooks`, `skills`, `commands`, `agents`, `scripts`. The current code is missing `agents` and `scripts` (Pitfall 6 from research). `getPackageRoot()` stays as the source (`join(import.meta.dirname, "..")`).

4. **Atomic install with rollback**:
   - Create a temp directory: `${megazordDir}.tmp.${Date.now()}`
   - Copy all dirs to temp
   - Write `.version` file to temp with VERSION content
   - If `megazordDir` exists, remove it
   - Rename temp to `megazordDir`
   - On ANY error in the try block: remove temp dir, print error, exit 1

5. **Register with Claude Code** — keep the dual approach (try `claude plugin` CLI first, fall back to manual JSON registration). BUT update paths:
   - In `installFallback`: the `installPath` in `installed_plugins.json` should point to `megazordDir` (not the cache path)
   - Keep `knownMarketplacesPath`, `installedPluginsPath`, `settingsPath` imports for the fallback
   - The marketplace still references the same marketplace name and plugin name

6. **Minimal output**:
   - On success: `console.log("Megazord v{VERSION} installed at {megazordDir}")` — single line, no banner, no spinner
   - On failure: `console.log("Error: {reason}")` then `process.exit(1)`
   - No environment detection output, no coexistence info, no empty lines

7. **Reinstall behavior**: If `megazordDir` already exists, just overwrite it (the atomic swap handles this). No "already installed" prompt.

**Also update `src/cli/utils/detect-plugins.ts`:**
- Import `megazordDir` from `../../lib/paths.js`
- Change `megazordInstalled` detection: check `existsSync(megazordDir)` instead of reading `installed_plugins.json` for `mz@` entries
- Keep the `installed_plugins.json` check as a secondary fallback (for users who installed with older version)

The `createLocalMarketplace` function is no longer needed for the primary install flow — the install copies files directly to `~/.claude/megazord/`. However, the Claude Code registration still needs the marketplace pattern. Simplify: the `installFallback` function should register `megazordDir` directly as the plugin's `installPath` without creating a separate `.megazord-marketplace` directory.

Keep `copyDirSync` helper (used by install). Keep `verifyInstallation` but update it to check `existsSync(megazordDir)` AND the installed_plugins.json entry.
  </action>
  <verify>
Run: `bun run typecheck` — must pass.
Run: `bun run build` — must succeed.
Run: `grep -c "confirm\|selectOption\|createInterface" src/cli/commands/install.ts` — should be 0 (no interactive prompts).
Run: `grep "agents.*scripts" src/cli/commands/install.ts` — should show both in the copy list.
Run: `grep "megazordDir" src/cli/commands/install.ts` — should show usage of new path.
  </verify>
  <done>install.ts copies 6 directories to ~/.claude/megazord/ atomically with rollback, no prompts, minimal output, and registers with Claude Code marketplace system</done>
</task>

<task type="auto">
  <name>Task 2: Refactor update.ts and uninstall.ts for new file placement</name>
  <files>src/cli/commands/update.ts, src/cli/commands/uninstall.ts</files>
  <action>
**Rewrite `src/cli/commands/update.ts`:**

1. **Remove ALL interactive prompts** — no `--yes` flag, no conditional output. Always silent.
2. **Use `~/.claude/megazord/` as target** — import `megazordDir`, `megazordVersionPath` from `../../lib/paths.js`.
3. **Check megazordDir exists** — if not, print error and exit 1.
4. **Copy ALL directories** to `megazordDir` (same 6 dirs as install: `.claude-plugin`, `hooks`, `skills`, `commands`, `agents`, `scripts`).
5. **Update `.version` file** with current VERSION.
6. **Minimal output**: `console.log("Megazord updated to v{VERSION}")` on success. Error message + exit 1 on failure.
7. **No spinner, no banner** — just the result line.

**Rewrite `src/cli/commands/uninstall.ts`:**

1. **Remove ALL interactive prompts** — no `confirm()`, no `createInterface`. Always silent.
2. **Remove `~/.claude/megazord/` directory** — `rmSync(megazordDir, { recursive: true, force: true })`.
3. **Deregister from Claude Code:**
   - Try `claude plugin uninstall mz` (keep existing try/catch pattern)
   - Try `claude plugin marketplace remove megazord-marketplace` (keep existing try/catch pattern)
   - Also clean up `installed_plugins.json`: remove the `mz@megazord-marketplace` entry if it exists
   - Also clean up `settings.json`: remove the `mz@megazord-marketplace` from `enabledPlugins` if it exists
4. **Minimal output**: `console.log("Megazord uninstalled")` on success. Single line.
5. **No spinner, no banner**.

For both files, import `rmSync` from `node:fs` as needed. Keep the `copyDirSync` helper in update.ts (or extract to a shared utility if it creates duplication — use judgment, but avoid over-engineering).
  </action>
  <verify>
Run: `bun run typecheck` — must pass.
Run: `bun run build` — must succeed.
Run: `grep -c "confirm\|selectOption\|createInterface" src/cli/commands/update.ts src/cli/commands/uninstall.ts` — should be 0.
Run: `grep "megazordDir" src/cli/commands/update.ts` — should show usage.
Run: `grep "megazordDir" src/cli/commands/uninstall.ts` — should show usage.
  </verify>
  <done>update.ts overwrites ~/.claude/megazord/ silently, uninstall.ts removes ~/.claude/megazord/ and deregisters from Claude Code, both with minimal output and no prompts</done>
</task>

<task type="auto">
  <name>Task 3: Implement update check utility and /mz:update command skill</name>
  <files>src/cli/utils/update-check.ts, commands/update.md</files>
  <action>
**Create `src/cli/utils/update-check.ts`** — a utility that checks the npm registry for a newer version of `megazord-cli` and writes the result to `~/.claude/megazord/.update-check`. This implements the CONTEXT locked decision: "Automatic update check: when user launches Claude Code with Megazord, check for new version and show message if available."

1. **Export a `checkForUpdate()` async function** that:
   - Reads the current installed version from `megazordVersionPath` (import from `../../lib/paths.js`). If the file doesn't exist, return early (not installed).
   - Checks if enough time has elapsed since last check. Read `megazordUpdateCheckPath` — if it exists and was written less than 24 hours ago, skip the check (avoid hammering the registry). Use `statSync` on the file's mtime.
   - Fetches the latest version from npm: `https://registry.npmjs.org/megazord-cli/latest` — extract the `version` field from the JSON response. Use `fetch()` with a 3-second timeout (AbortController). On network error, silently return (non-blocking).
   - Compares the installed version (from .version file) with the latest version using simple string comparison (both are semver strings). If they differ, write a JSON file to `megazordUpdateCheckPath` containing `{ "latest": "<version>", "current": "<version>", "checked": "<ISO timestamp>" }`.
   - If versions match, write the same JSON but the consumer (session-start hook) knows not to display a notification when `latest === current`.

2. **Export a `getUpdateNotification()` function** (sync) that:
   - Reads `megazordUpdateCheckPath`. If it doesn't exist, return `null`.
   - Parses the JSON. If `latest !== current`, return a string: `"Megazord v{latest} available — run: megazord-cli update"`.
   - Otherwise return `null`.

3. **Wire into the install command**: At the end of `install.ts` (after successful install), call `checkForUpdate()` in a fire-and-forget manner (`checkForUpdate().catch(() => {})`) — this seeds the .update-check file on first install. Do NOT await it or let it block the install output.

**Create `commands/update.md`** — a Claude Code slash command skill that provides the `/mz:update` channel (CONTEXT locked decision: "Dual update channels: `megazord-cli update` CLI AND `/mz:update` skill from within Claude Code session").

The file should follow the existing command file pattern in `commands/` directory:

```markdown
---
name: update
description: Update Megazord to the latest version
---

Update Megazord to the latest version by running the CLI update command.

Run the following command:
\`\`\`bash
bunx megazord-cli@latest update
\`\`\`

After the command completes, report the output to the user. The update replaces all Megazord files in `~/.claude/megazord/` with the latest version. No restart of Claude Code is needed — the updated skills and hooks take effect on the next session.
```

**IMPORTANT**: The `/mz:update` skill delegates to `bunx megazord-cli@latest update` (with `@latest` to ensure fetching the newest published version). It does NOT contain hardcoded file paths to `~/.claude/megazord/` or any direct file manipulation — all logic lives in the CLI's `update.ts`.
  </action>
  <verify>
Run: `bun run typecheck` — must pass.
Run: `bun run build` — must succeed.
Run: `grep "megazordUpdateCheckPath" src/cli/utils/update-check.ts` — should show import of the path constant.
Run: `grep "registry.npmjs.org" src/cli/utils/update-check.ts` — should show the npm registry URL.
Run: `grep "megazord-cli" commands/update.md` — should show the update command reference.
Run: `grep -r "checkForUpdate" src/cli/commands/install.ts` — should show the fire-and-forget call.
Verify: `commands/update.md` does NOT contain hardcoded paths like `~/.claude/megazord/` in executable instructions (only in explanatory text).
  </verify>
  <done>update-check.ts queries npm registry with 24h cache and writes .update-check file; commands/update.md provides /mz:update skill delegating to megazord-cli update; install.ts seeds the update check on first install</done>
</task>

</tasks>

<verification>
1. `bun run build` succeeds
2. `bun run typecheck` passes
3. No interactive prompts remain in install/update/uninstall (grep for confirm, selectOption, createInterface returns 0)
4. All three commands use megazordDir from paths.ts
5. install.ts copies 6 directories (.claude-plugin, hooks, skills, commands, agents, scripts)
6. install.ts writes .version file
7. install.ts has rollback (try/catch with temp dir cleanup)
8. detect-plugins.ts checks megazordDir existence
9. update-check.ts exports checkForUpdate and getUpdateNotification functions
10. update-check.ts uses megazordUpdateCheckPath from paths.ts
11. commands/update.md exists and delegates to `bunx megazord-cli@latest update`
12. install.ts calls checkForUpdate() fire-and-forget after successful install
</verification>

<success_criteria>
- `bunx megazord-cli install` on a machine with Claude Code copies all plugin files to `~/.claude/megazord/` with zero prompts
- Install failure cleans up partial state (no orphaned temp directories)
- `bunx megazord-cli update` refreshes all files in `~/.claude/megazord/`
- `bunx megazord-cli uninstall` removes `~/.claude/megazord/` and deregisters from Claude Code
- Output for all three commands is a single result line
- Update check utility queries npm registry with 24h caching and writes `.update-check` JSON file
- `/mz:update` command skill exists in `commands/update.md` and delegates to `megazord-cli update`
</success_criteria>

<output>
After completion, create `.planning/phases/15-npm-publication/15-02-SUMMARY.md`
</output>
