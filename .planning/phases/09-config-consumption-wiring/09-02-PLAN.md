---
phase: 09-config-consumption-wiring
plan: 02
type: execute
wave: 2
depends_on:
  - "09-01"
files_modified:
  - skills/plan/SKILL.md
  - skills/plan/agents.md
  - skills/map/SKILL.md
  - skills/map/mapper.md
autonomous: true
requirements:
  - CONF-03
  - CONF-02

must_haves:
  truths:
    - "/mz:plan passes the resolved model when spawning researcher and planner agents"
    - "/mz:map passes the resolved model when spawning mapper agents"
    - "/mz:plan skips plan-checker agent when workflow.plan_check is false"
    - "/mz:plan shows a soft brainstorming suggestion when quality.brainstorming is true and no CONTEXT.md exists"
    - "Manual /mz:review always works regardless of quality.review config setting"
  artifacts:
    - path: "skills/plan/SKILL.md"
      provides: "Model-aware researcher/planner spawning, plan_check toggle, brainstorming suggestion"
      contains: "resolveAgentModel"
    - path: "skills/plan/agents.md"
      provides: "Updated spawning pattern docs showing model parameter"
      contains: "model"
    - path: "skills/map/SKILL.md"
      provides: "Model-aware mapper spawning"
      contains: "resolveAgentModel"
    - path: "skills/map/mapper.md"
      provides: "Updated spawning pattern docs showing model parameter"
      contains: "model"
  key_links:
    - from: "skills/plan/SKILL.md"
      to: "agents/mz-researcher.md"
      via: "Dynamic frontmatter rewrite before Task spawn"
      pattern: "model.*frontmatter"
    - from: "skills/plan/SKILL.md"
      to: "src/lib/config.ts"
      via: "resolveAgentModel() call to determine model"
      pattern: "resolveAgentModel"
---

<objective>
Wire model selection and toggle gating into the /mz:plan and /mz:map orchestrator skills. After this plan, model_profile and model_overrides from config actually control which models agents use, and plan_check/brainstorming toggles gate their respective behaviors.

Purpose: Makes config settings drive behavior in the planning and mapping skills -- the first half of "config consumption wiring."
Output: Updated SKILL.md and agents.md files for plan and map skills with model-aware spawning and toggle gating.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-config-consumption-wiring/09-01-SUMMARY.md
@src/lib/config.ts
@skills/plan/SKILL.md
@skills/plan/agents.md
@skills/map/SKILL.md
@skills/map/mapper.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire model selection and toggle gating into /mz:plan</name>
  <files>
    skills/plan/SKILL.md
    skills/plan/agents.md
  </files>
  <action>
### Part A: Model Selection in /mz:plan

In `skills/plan/SKILL.md`, add model resolution logic to the agent spawning steps.

**Step 5 (Research Phase) modifications:**

After the instruction "Read `{plugin_path}/agents/mz-researcher.md` file content into memory" (line area around current step 5), add a model resolution step:

```
Resolve the model for the researcher agent:
1. Read `model_profile` and `model_overrides` from the loaded config.
2. Determine the model: check if `model_overrides.researcher` is set and not "inherit". If so, use that value. Otherwise, use the profile mapping: quality->opus, balanced->sonnet, budget->haiku.
3. Update the researcher agent file's YAML frontmatter `model` field to the resolved value. Use gray-matter or simple string replacement to rewrite the `model: {value}` line in `{plugin_path}/agents/mz-researcher.md`.
```

Then update the Task spawn to use the registered subagent name instead of "general-purpose":
- Change `subagent_type`: from `"general-purpose"` to `"mz-researcher"`
- The prompt no longer needs to include the full agent definition in `<agent_role>` tags (Claude Code loads it from the agent file). Instead, the prompt carries only per-invocation context: state, roadmap section, context decisions, output path.
- BUT: Keep the inline embedding as a fallback paragraph. Add a note: "If spawning with subagent_type='mz-researcher' fails, fall back to subagent_type='general-purpose' with the agent definition embedded inline in `<agent_role>` tags (same as the current pattern)."

**Step 6 (Create Plans) modifications:**

Same pattern for the planner agent:
1. Resolve model for planner: check `model_overrides.planner`, fall back to profile mapping. Note differentiated balanced profile: planner gets opus for balanced profile, sonnet for budget.
2. Update `{plugin_path}/agents/mz-planner.md` frontmatter model field.
3. Change spawn to `subagent_type="mz-planner"` with fallback to "general-purpose" + inline embedding.

### Part B: plan_check Toggle in /mz:plan

Add a new **Step 6b** after Step 6 (Create Plans) and before Step 7 (Update State):

```markdown
## Step 6b: Plan Verification (conditional)

Determine whether to run plan verification:

1. **Check config:** Read `workflow.plan_check` from megazord.config.json. If false, skip to Step 7.

**If plan_check is enabled:**

Display:
\```
â–¸ Plan Check
  â—† Validating plans...
\```

For each created PLAN.md file, validate using the CLI tool:
\```bash
node {plugin_path}/bin/megazord.mjs tools frontmatter validate "{plan_path}" --schema plan
\```

And validate plan structure:
\```bash
node {plugin_path}/bin/megazord.mjs tools verify plan-structure "{plan_path}"
\```

If validation errors are found:
- Display each error with the plan file and issue description
- Attempt to fix common issues (missing elements, frontmatter problems) by re-reading the plan file and making targeted edits
- Re-validate after fixes

Display result:
\```
â–¸ Plan Check
  âœ“ {N} plan(s) validated
\```

Or if issues remain:
\```
â–¸ Plan Check
  âš  {N} issue(s) found -- check plan files manually
\```

**If plan_check was skipped (config):**
\```
â–¸ Plan Check
  ~ Skipped (disabled in config)
\```
```

### Part C: Brainstorming Suggestion in /mz:plan

Modify **Step 4** (Soft Check for CONTEXT.md). When CONTEXT.md is missing AND `quality.brainstorming` is true in config, enhance the existing warning to include a brainstorming suggestion:

Change the existing "No context found" warning display to:
```
â–¸ Context
  âš  No context found for Phase {N}.
  ðŸ’¡ Brainstorming is enabled -- run /mz:discuss first for better results, or continue without.
```

When `quality.brainstorming` is false, keep the existing warning without the brainstorming mention:
```
â–¸ Context
  âš  No context found for Phase {N}. Run /mz:discuss first for better results, or continue without.
```

The AskUserQuestion options remain the same in both cases. This is a soft suggestion only -- it does NOT block planning.

### Part D: Update agents.md

In `skills/plan/agents.md`, update the spawning documentation to reflect the new model-aware pattern:

1. In the Researcher Agent section, add:
   - "**Model:** Determined by `resolveAgentModel(config, 'researcher')` -- config profile mapping with optional override"
   - Update spawning from `subagent_type="general-purpose"` to `subagent_type="mz-researcher"` with fallback note

2. In the Planner Agent section, add:
   - "**Model:** Determined by `resolveAgentModel(config, 'planner')` -- note: balanced profile uses opus for planner"
   - Update spawning from `subagent_type="general-purpose"` to `subagent_type="mz-planner"` with fallback note

3. Update the spawning examples section to show the new pattern:
   - Before spawn: resolve model, update agent frontmatter
   - Spawn with subagent_type=agent name
   - Fallback to general-purpose + inline embedding

4. Add a new section "## Model Selection" explaining:
   - Profile mapping table (quality/balanced/budget -> models per role)
   - Override precedence: override wins over profile
   - Frontmatter rewriting: skills update the model field in agent .md files before spawning
   - Session restart caveat: model changes may require session restart if Claude Code caches agent definitions
  </action>
  <verify>
    - `skills/plan/SKILL.md` contains "resolveAgentModel" or model resolution instructions
    - `skills/plan/SKILL.md` contains "mz-researcher" as subagent_type
    - `skills/plan/SKILL.md` contains "mz-planner" as subagent_type
    - `skills/plan/SKILL.md` contains a "Step 6b" section for plan_check
    - `skills/plan/SKILL.md` Step 4 mentions brainstorming when context is missing
    - `skills/plan/agents.md` documents the model selection pattern
    - `skills/plan/agents.md` shows the updated spawning examples
  </verify>
  <done>
    - /mz:plan resolves and applies models for researcher and planner agents before spawning
    - /mz:plan checks workflow.plan_check and conditionally runs plan validation after plan creation
    - /mz:plan shows brainstorming suggestion when quality.brainstorming is true and no CONTEXT.md exists
    - agents.md documents the model-aware spawning pattern with examples
    - Fallback to general-purpose + inline embedding documented for robustness
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire model selection into /mz:map</name>
  <files>
    skills/map/SKILL.md
    skills/map/mapper.md
  </files>
  <action>
### Part A: Model Selection in /mz:map

In `skills/map/SKILL.md`, add model resolution logic to Step 5 (Spawn Mapper Agents).

Before the "For each selected focus area" spawning loop, add:

```markdown
### Resolve Model for Mapper Agents

Before spawning, determine the model for mapper agents:

1. Read `model_profile` and `model_overrides` from the loaded config.
2. Determine the mapper model: check if `model_overrides.mapper` is set and not "inherit". If so, use that value. Otherwise, use the profile mapping: quality->opus, balanced->sonnet, budget->haiku.
3. Update `{plugin_path}/agents/mz-mapper.md` frontmatter `model` field to the resolved value. Use simple string replacement to rewrite the `model: {value}` line.
```

Then update the spawning pattern for each focus area agent:
- Change `subagent_type="general-purpose"` to `subagent_type="mz-mapper"` in all 4 (or 1, when focused) spawns.
- The prompt no longer wraps the agent definition in `<agent_role>` tags. Instead, it passes only the per-invocation context: `<focus>`, `<output_dir>`, `<instructions>`.
- Add a fallback note: "If spawning with subagent_type='mz-mapper' fails, fall back to subagent_type='general-purpose' with the agent definition embedded inline."

For the synthesis agent (Step 6), apply the same pattern:
- Update the synthesis spawn to use `subagent_type="mz-mapper"` (same agent, different focus).
- The model is already set from the frontmatter update above.

### Part B: Update mapper.md

In `skills/map/mapper.md`, update the spawning documentation:

1. Add a "**Model:**" line to the Mapper Agent section:
   - "**Model:** Determined by `resolveAgentModel(config, 'mapper')` -- config profile mapping with optional override"

2. Update the "Parallel Spawning Pattern" section:
   - Change `subagent_type="general-purpose"` to `subagent_type="mz-mapper"` in examples
   - Add a step before spawning: "Resolve model and update agent frontmatter"
   - Add fallback note

3. Add a brief "## Model Selection" note explaining that the orchestrator resolves the model before spawning and updates the agent file's frontmatter.
  </action>
  <verify>
    - `skills/map/SKILL.md` contains model resolution instructions in Step 5
    - `skills/map/SKILL.md` uses `subagent_type="mz-mapper"` for spawns
    - `skills/map/mapper.md` documents the model-aware spawning pattern
    - `skills/map/mapper.md` mentions resolveAgentModel
  </verify>
  <done>
    - /mz:map resolves and applies models for mapper agents before spawning
    - All mapper spawns (focus areas + synthesis) use registered subagent names
    - mapper.md documents the updated spawning pattern
    - Fallback to general-purpose + inline embedding documented
  </done>
</task>

</tasks>

<verification>
- skills/plan/SKILL.md has model-aware spawning for both researcher and planner
- skills/plan/SKILL.md has plan_check toggle gating (Step 6b)
- skills/plan/SKILL.md has brainstorming suggestion when context is missing
- skills/map/SKILL.md has model-aware spawning for mapper agents
- All agent spawning documentation updated in agents.md and mapper.md
- No skill gates manual invocation behind config toggles (manual skills always work)
</verification>

<success_criteria>
- Model resolution is documented and integrated into /mz:plan and /mz:map spawning
- workflow.plan_check toggle gates plan validation in /mz:plan
- quality.brainstorming toggle shows a soft suggestion in /mz:plan when no context exists
- Spawning pattern updated from general-purpose to named subagent types with fallback
- Supporting agent docs (agents.md, mapper.md) reflect the new patterns
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-consumption-wiring/09-02-SUMMARY.md`
</output>
