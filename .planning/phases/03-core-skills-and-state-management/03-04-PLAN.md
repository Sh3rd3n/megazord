---
phase: 03-core-skills-and-state-management
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/commands/update.ts
  - src/cli/index.ts
  - package.json
autonomous: false
gap_closure: true
requirements: [DIST-02, PROJ-04, PROJ-05, PROJ-06, PROJ-07]

must_haves:
  truths:
    - "All 8 functional skills (help, init, settings, plan, status, pause, resume, quick) appear in /mz: autocomplete in Claude Code"
    - "The 6 stub skills (go, review, verify, debug, discuss, map) remain as stubs with disable-model-invocation: true in cache"
    - "Running `megazord update` syncs source skills to the plugin cache without reinstalling"
    - "Running `bun run build` automatically syncs skills to cache via postbuild script"
  artifacts:
    - path: "src/cli/commands/update.ts"
      provides: "update command that copies skills/ to plugin cache"
      exports: ["update"]
    - path: "src/cli/index.ts"
      provides: "registers `megazord update` subcommand"
      contains: "update"
    - path: "package.json"
      provides: "postbuild script that runs `megazord update --yes`"
      contains: "postbuild"
  key_links:
    - from: "src/cli/commands/update.ts"
      to: "~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/skills/"
      via: "copyDirSync (same pattern as installFallback in install.ts)"
      pattern: "copyDirSync.*skills"
    - from: "package.json postbuild"
      to: "src/cli/commands/update.ts"
      via: "bun run build && megazord update --yes"
      pattern: "postbuild"
---

<objective>
Fix stale plugin cache so all functional Megazord skills become invocable from Claude Code.

Purpose: Phase 3 execution updated source skills (skills/*/SKILL.md) but the plugin cache at ~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/ was not refreshed. Claude Code reads from the cache, so it still sees 13-line stubs with disable-model-invocation: true instead of the 96-286 line functional skills. This blocks all Phase 3 UAT tests 3-8.

Output: A `megazord update` CLI command that syncs source skills to cache, a postbuild hook ensuring future builds keep the cache current, and a cache that reflects the current source state.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-skills-and-state-management/03-03-SUMMARY.md
@src/cli/commands/install.ts
@src/cli/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add `megazord update` command and postbuild hook</name>
  <files>src/cli/commands/update.ts, src/cli/index.ts, package.json</files>
  <action>
    Create `src/cli/commands/update.ts` with an `update()` export that:
    - Resolves the package root (same pattern as install.ts: `join(import.meta.dirname, "..")`)
    - Resolves the cache target: `~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/` — use `pluginsCacheDir` from `../../lib/paths.js` joined with `megazord-marketplace/mz/0.1.0`
    - Checks the cache exists (if not, prints "Megazord not installed — run `megazord install` first" and exits with code 1)
    - Copies `skills/` from package root to `{cacheTarget}/skills/` using `copyDirSync` (copy the function verbatim from install.ts — it recursively overwrites, which is the desired behavior)
    - Copies `hooks/` and `commands/` directories if they exist, using the same copyDirSync loop as installFallback in install.ts (dirsToCopy: ["hooks", "skills", "commands"])
    - Does NOT touch `.claude-plugin/` (plugin.json manifest does not need updating, only skill content)
    - Prints success: "Megazord updated — {N} skills synced to cache" where N is the count of skill directories copied
    - Accepts `--yes` flag (for non-interactive use in postbuild)

    In `src/cli/index.ts`, register the new command after the existing `uninstall` command block:
    ```
    program
      .command("update")
      .description("Sync skills from source to plugin cache")
      .option("--yes", "Skip confirmation prompts")
      .action(async () => {
        const { update } = await import("./commands/update.js");
        await update();
      });
    ```

    In `package.json`, add a `postbuild` script so every `bun run build` automatically syncs:
    ```json
    "postbuild": "node bin/megazord.mjs update --yes"
    ```
    Place it after the existing `"build": "tsdown"` entry. Note: `postbuild` runs automatically after `build` completes — no manual step needed.
  </action>
  <verify>
    Run `bun run build` and confirm it exits 0 and prints "Megazord updated" at the end of build output (postbuild fires automatically).

    Then run: `node /Users/sh3rd3n/Programming/Megazord/bin/megazord.mjs update --yes`
    Expected output includes: "Megazord updated" with a skill count.

    Then check cache values:
    ```
    grep "disable-model-invocation" ~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/skills/plan/SKILL.md
    grep "disable-model-invocation" ~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/skills/status/SKILL.md
    ```
    Both must return `disable-model-invocation: false`.

    Check line counts to confirm full skills are in cache:
    ```
    wc -l ~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/skills/plan/SKILL.md
    ```
    Must be > 100 lines (source is 286).
  </verify>
  <done>
    - `megazord update --yes` runs without error and exits 0
    - `disable-model-invocation` is `false` in cache for: init, settings, plan, status, pause, resume, quick
    - `disable-model-invocation` is `true` in cache for: go, review, verify, debug, discuss, map (stubs preserved correctly)
    - `disable-model-invocation` is `false` in cache for: help (already correct, must remain correct)
    - `bun run build` triggers postbuild and syncs cache automatically
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify functional skills are invocable in Claude Code</name>
  <files>~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/skills/</files>
  <action>Human verification that Claude Code autocomplete shows all 8 functional skills and they can be invoked</action>
  <verify>
    In Claude Code (new conversation or after reloading):

    1. Type `/mz:` and press Tab to open autocomplete
       Expected: See multiple skills listed — plan, status, pause, resume, quick, help, init, settings (at minimum 8 functional skills)
       Failure: Only /mz:help appears

    2. Run `/mz:plan` (or `/mz:status`)
       Expected: Skill executes and Claude responds with its content
       Failure: Says "this skill is not yet available" or similar stub message

    3. Run `/mz:go` (a stub skill)
       Expected: Shows the informative stub message about Phase 4
       This confirms stubs are still correctly disabled

    If autocomplete still shows only /mz:help, Claude Code may need to be restarted to pick up cache changes.
  </verify>
  <done>All 8 functional skills appear in autocomplete and execute correctly. 6 stubs remain disabled.</done>
  <what-built>
    megazord update command that syncs source skills to plugin cache, plus postbuild hook. Cache has been refreshed with functional skills having disable-model-invocation: false.
  </what-built>
  <how-to-verify>See verify section above</how-to-verify>
  <resume-signal>Type "approved" if all 8 functional skills appear in autocomplete and invoke correctly, or describe what you see</resume-signal>
</task>

</tasks>

<verification>
- `grep -r "disable-model-invocation: false" ~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/skills/` returns 8 matches (help, init, settings, plan, status, pause, resume, quick)
- `grep -r "disable-model-invocation: true" ~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/skills/` returns 6 matches (go, review, verify, debug, discuss, map)
- `wc -l ~/.claude/plugins/cache/megazord-marketplace/mz/0.1.0/skills/plan/SKILL.md` shows > 100 lines
- `cat package.json | grep postbuild` shows the postbuild script
- `bun run build` exits 0 and prints update confirmation
</verification>

<success_criteria>
All 8 functional Megazord skills (help, init, settings, plan, status, pause, resume, quick) are invocable from Claude Code via /mz:comando. Claude Code autocomplete shows all 8 under /mz:. The 6 stubs remain correctly disabled. Future builds automatically keep the cache synchronized via postbuild.
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-skills-and-state-management/03-04-SUMMARY.md`
</output>
