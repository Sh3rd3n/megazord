---
phase: 03-core-skills-and-state-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - skills/plan/SKILL.md
  - skills/plan/agents.md
  - agents/mz-researcher.md
  - agents/mz-planner.md
autonomous: true
requirements: [PROJ-02, PROJ-03, PROJ-11]

must_haves:
  truths:
    - "Running /mz:plan shows a stage banner, loads project context, determines target phase, and orchestrates research + planning via Task tool subagents"
    - "The plan skill warns (but doesn't block) when CONTEXT.md is missing for the target phase"
    - "Research runs by default before planning; --skip-research flag skips it"
    - "The planner agent produces PLAN.md files with GSD-compatible format (frontmatter + XML tasks)"
    - "If ROADMAP.md doesn't exist, /mz:plan guides the user through roadmap creation before planning"
  artifacts:
    - path: "skills/plan/SKILL.md"
      provides: "Full /mz:plan orchestration skill replacing stub"
      min_lines: 150
    - path: "skills/plan/agents.md"
      provides: "Agent role definitions referenced by the plan skill"
      min_lines: 40
    - path: "agents/mz-researcher.md"
      provides: "Phase researcher agent definition for Task tool spawning"
      min_lines: 50
    - path: "agents/mz-planner.md"
      provides: "Phase planner agent definition for Task tool spawning"
      min_lines: 80
  key_links:
    - from: "skills/plan/SKILL.md"
      to: "agents/mz-researcher.md"
      via: "Read file + embed in Task prompt"
      pattern: "agents/mz-researcher"
    - from: "skills/plan/SKILL.md"
      to: "agents/mz-planner.md"
      via: "Read file + embed in Task prompt"
      pattern: "agents/mz-planner"
    - from: "skills/plan/SKILL.md"
      to: "src/cli (via Bash)"
      via: "megazord tools state"
      pattern: "megazord tools"
---

<objective>
Create the /mz:plan skill that orchestrates the research-then-plan pipeline via Task tool subagents, along with the agent definition files it references.

Purpose: /mz:plan is the primary entry point for project work decomposition. It reads project context, optionally spawns a researcher, then spawns a planner to produce PLAN.md files. This enables the core planning workflow: discuss (optional) -> research (optional) -> plan -> execute.

Output: Functional /mz:plan skill (SKILL.md + agents.md), two agent definitions (mz-researcher.md, mz-planner.md) in agents/ directory.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-skills-and-state-management/03-RESEARCH.md
@.planning/phases/03-core-skills-and-state-management/03-CONTEXT.md
@skills/init/design-system.md
@skills/init/SKILL.md
@src/lib/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent definitions (mz-researcher.md, mz-planner.md)</name>
  <files>
agents/mz-researcher.md
agents/mz-planner.md
skills/plan/agents.md
  </files>
  <action>
**Create `agents/mz-researcher.md`:**

A Megazord phase researcher agent definition. The skill reads this file and embeds its content in the Task tool prompt. Structure:

```markdown
# Megazord Phase Researcher

You are a phase researcher for Megazord. Your job is to research the technical landscape for a specific phase before planning begins.

## Your Objective
Research the requirements, technical stack, and architecture patterns needed for the target phase. Produce a RESEARCH.md file that the planner agent will use.

## Input
You receive:
- Phase number and name
- Phase requirements from ROADMAP.md
- Current project state from STATE.md
- User decisions from CONTEXT.md (if available)

## Output
Write a research document to the specified output path with:
1. **Summary** -- what this phase delivers and key technical considerations
2. **User Constraints** -- locked decisions from CONTEXT.md (copy verbatim)
3. **Phase Requirements** -- table of requirement IDs with research support analysis
4. **Standard Stack** -- libraries already in the project that apply
5. **Architecture Patterns** -- recommended patterns with code examples
6. **Don't Hand-Roll** -- things to use existing libraries/patterns for
7. **Common Pitfalls** -- what can go wrong and how to avoid it

## Rules
- Focus on what's ALREADY in the project first (check package.json, existing code)
- Use existing patterns from prior phases (check SUMMARY.md files)
- Only recommend new dependencies if truly necessary
- Respect locked decisions from CONTEXT.md -- never contradict them
- Be specific: file paths, function signatures, code examples
```

**Create `agents/mz-planner.md`:**

A Megazord phase planner agent definition. Modeled after GSD's planner but adapted for Megazord. Structure:

```markdown
# Megazord Phase Planner

You are a phase planner for Megazord. Your job is to decompose a phase into executable plans with tasks, dependencies, and completion criteria.

## Your Objective
Create PLAN.md files that an executor agent can implement without interpretation. Plans are prompts, not documents.

## Input
You receive:
- Phase number, name, and requirements
- Research findings (from researcher agent)
- User decisions from CONTEXT.md (if available)
- Project state from STATE.md
- Roadmap from ROADMAP.md

## Plan Format
Each PLAN.md follows this structure:
[Include the GSD-compatible plan format from research -- YAML frontmatter with phase, plan, type, wave, depends_on, files_modified, autonomous, requirements, must_haves; then XML sections: objective, context, tasks, verification, success_criteria, output]

## Task Structure
Each task has: <name>, <files>, <action>, <verify>, <done>
- name: Action-oriented, starts with "Task N: "
- files: Exact paths created or modified
- action: Specific implementation instructions
- verify: Command or check to prove completion
- done: Measurable acceptance criteria

## Rules
- 2-3 tasks per plan, targeting ~50% context budget
- Adaptive granularity: simple tasks get coarse decomposition, complex get fine-grained
- Every requirement ID must appear in at least one plan's requirements field
- Honor locked decisions from CONTEXT.md exactly
- Never implement deferred ideas
- Prefer vertical slices over horizontal layers
- Must-haves derived using goal-backward methodology
```

**Create `skills/plan/agents.md`:**

A supporting file for the plan skill that lists agent definitions and their roles:

```markdown
# Plan Skill Agents

## Researcher Agent
- **File:** agents/mz-researcher.md (read this file and embed content in Task prompt)
- **Purpose:** Research technical landscape for a phase before planning
- **Spawning:** Task tool with subagent_type="general-purpose"
- **Output:** {phase_dir}/{padded}-RESEARCH.md

## Planner Agent
- **File:** agents/mz-planner.md (read this file and embed content in Task prompt)
- **Purpose:** Decompose phase into executable PLAN.md files
- **Spawning:** Task tool with subagent_type="general-purpose"
- **Output:** {phase_dir}/{padded}-{NN}-PLAN.md files

## Critical: @file References
@file references do NOT work across Task tool boundaries. The plan skill MUST:
1. Read the agent definition file content into memory
2. Read all context files (STATE.md, ROADMAP.md, etc.) into memory
3. Embed both as inline text in the Task prompt string
```
  </action>
  <verify>
Verify all three files exist: `ls agents/mz-researcher.md agents/mz-planner.md skills/plan/agents.md`. Each file should be non-empty with the documented structure.
  </verify>
  <done>
Agent definition files exist in agents/ directory. Supporting agents.md exists in skills/plan/. Researcher defines research output format. Planner defines GSD-compatible plan format. agents.md documents the @file reference limitation and correct spawning pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /mz:plan skill (SKILL.md)</name>
  <files>skills/plan/SKILL.md</files>
  <action>
Replace the stub content in `skills/plan/SKILL.md` with the full /mz:plan orchestration skill. Reference `@skills/init/design-system.md` for visual formatting and `@skills/plan/agents.md` for agent definitions.

**Frontmatter:**
```yaml
---
name: plan
description: Plan a phase into executable tasks with dependencies and waves
disable-model-invocation: false
---
```

Note: `disable-model-invocation: false` because this is now a functional skill that needs model invocation.

**Skill flow (8 steps):**

**Step 1: Display Banner**
Show stage banner: `MEGAZORD > PLANNING`

**Step 2: Load Project Context**
- Read `.planning/megazord.config.json` -- if missing, show error box and suggest `/mz:init`. Stop.
- Read `.planning/STATE.md` for current position.
- Read `.planning/ROADMAP.md` for phase listing.
- Parse user arguments: look for phase number and `--skip-research` flag in the user's message.

**Step 3: Determine Target Phase**
- If phase number provided in user message: use it.
- If not: find the next unplanned phase from ROADMAP.md -- first phase marked `- [ ]` that has no PLAN.md files in its phase directory.
- If no ROADMAP.md exists: this is a new project. Guide the user through roadmap creation:
  1. Use AskUserQuestion (header: "Roadmap", question: "No roadmap found. Would you like to create one?", options: "Yes, create roadmap" / "No, use /mz:quick instead")
  2. If yes: ask the user to describe their project vision and goals. Then create ROADMAP.md with phases based on their description. After roadmap creation, proceed to plan the first phase.
  3. If no: suggest `/mz:quick` and exit.
- Display: "Planning Phase {N}: {Name}"

**Step 4: Soft Check for CONTEXT.md**
- Check if `{phase_dir}/{padded}-CONTEXT.md` exists.
- If missing: display warning using design system `Warning` symbol:
  "No context found for Phase {N}. Run /mz:discuss first for better results, or continue without."
- Use AskUserQuestion: header: "Context" (7 chars), question: "Continue planning without context?", options: "Continue" / "Run /mz:discuss first"
- If "Run /mz:discuss first": display the command and exit.
- Per user decision: this is a soft check -- warn but don't block.

**Step 5: Research Phase (conditional)**
- Check config: `workflow.research` setting
- Check flag: `--skip-research` in user arguments
- Check existing: does `{phase_dir}/{padded}-RESEARCH.md` already exist?
- If research enabled AND no --skip-research AND no existing RESEARCH.md:
  1. Read `agents/mz-researcher.md` file content
  2. Read all context files: STATE.md, ROADMAP.md, CONTEXT.md (if exists)
  3. Extract the relevant phase section from ROADMAP.md (not the entire file)
  4. Spawn researcher via Task tool:
     - subagent_type: "general-purpose"
     - description: "Research Phase {N}: {Name}"
     - prompt: Include agent definition text + all context as inline text + output path
  5. Wait for completion. Display progress with design system spinner.
- If research skipped: display note "Skipping research (--skip-research flag)"
- If research exists: display note "Using existing research"

**Step 6: Create Plans**
- Read all gathered context:
  - STATE.md content
  - ROADMAP.md content (phase section only)
  - RESEARCH.md content (from step 5 or existing)
  - CONTEXT.md content (if exists)
  - megazord.config.json (for depth, mode settings)
- Read `agents/mz-planner.md` file content
- Spawn planner via Task tool:
  - subagent_type: "general-purpose"
  - description: "Plan Phase {N}: {Name}"
  - prompt: Include planner agent definition + all context as inline text + phase dir for output + requirement IDs that must be covered + depth setting from config
- Wait for completion. The planner writes PLAN.md files directly.
- Verify PLAN.md files were created by listing {phase_dir}/{padded}-*-PLAN.md

**Step 7: Update State**
- Count created PLAN.md files
- Run: `node {plugin_path}/bin/megazord.mjs tools state update-position --plan 0 --status "Planned"` via Bash
- Update ROADMAP.md: replace the "Plans:" section for this phase with actual plan filenames and brief objectives (read each PLAN.md frontmatter objective)

**Step 8: Present Results**
- Display action box with plan summary:
  - Number of plans created
  - Brief objective of each plan
  - Wave structure
- Display Next Up block: `/mz:go` to execute the plans

**IMPORTANT implementation notes:**
- All file contents must be read BEFORE spawning Task subagents and embedded as inline text. @file references do NOT work across Task boundaries.
- The plan skill is the conductor; agents are the musicians. The skill handles flow, error cases, and state updates. Agents do the domain work.
- Keep SKILL.md under ~400 lines by delegating detail to agents.md supporting file.
  </action>
  <verify>
Verify skills/plan/SKILL.md exists and is functional (not a stub): `grep "disable-model-invocation: false" skills/plan/SKILL.md` should match. `grep -c "Step" skills/plan/SKILL.md` should show 8 steps. File should be 150+ lines.
  </verify>
  <done>
/mz:plan skill is fully functional with 8-step orchestration flow. It loads project context, determines target phase, soft-checks for CONTEXT.md, optionally runs research via subagent, spawns planner subagent, updates STATE.md, and presents results. Agent definitions are read and embedded in Task prompts (not @-referenced). Roadmap creation is handled for new projects.
  </done>
</task>

</tasks>

<verification>
1. skills/plan/SKILL.md has `disable-model-invocation: false` (functional, not stub)
2. skills/plan/agents.md documents agent spawning patterns and @file limitation
3. agents/mz-researcher.md defines research output format
4. agents/mz-planner.md defines GSD-compatible plan format
5. Plan skill references design-system.md for visual formatting
6. Soft check for CONTEXT.md warns but doesn't block (per user decision)
7. Research is default-on with --skip-research flag (per user decision)
8. Multi-plan approach supported (planner decides how many plans)
</verification>

<success_criteria>
/mz:plan is a fully functional skill that orchestrates the research-then-plan pipeline. It handles both new projects (no ROADMAP.md) and existing projects (plan next phase). Agent definitions exist and follow the embed-in-prompt pattern. The skill respects all locked user decisions: research default-on, soft CONTEXT.md check, adaptive granularity, multi-plan approach.
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-skills-and-state-management/03-02-SUMMARY.md`
</output>
