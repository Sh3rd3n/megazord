---
phase: 14-ci-cd-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/release.yml]
autonomous: false
requirements: [CICD-02, CICD-03, CICD-04]

user_setup:
  - service: npmjs.com
    why: "OIDC Trusted Publishing configuration — required for automated npm publish from CI"
    env_vars: []
    dashboard_config:
      - task: "Configure Trusted Publishing connection"
        location: "https://www.npmjs.com/package/megazord-cli/access → Trusted Publisher → GitHub Actions"
  - service: github.com
    why: "Repository must be public for npm provenance attestation"
    dashboard_config:
      - task: "Make repository public"
        location: "https://github.com/sh3rd3n/megazord/settings → Danger Zone → Change visibility"

must_haves:
  truths:
    - "Pushing a vX.Y.Z tag triggers the release workflow"
    - "Release workflow builds with bun and publishes with npm CLI (not bun)"
    - "npm publish uses --provenance flag for cryptographic attestation"
    - "OIDC Trusted Publishing is used (zero static npm tokens)"
    - "Tag version is validated against package.json version before publishing"
    - "Quality checks (typecheck, lint, test) re-run before publishing as safety net"
    - "A GitHub Release is automatically created from the tag"
    - "Repository is public (required for provenance)"
    - "Branch protection prevents force push to master and requires CI to pass for PRs"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Tag-triggered npm publish workflow with OIDC provenance"
      contains: "npm publish --provenance"
    - path: ".github/workflows/release.yml"
      provides: "Version validation step"
      contains: "GITHUB_REF_NAME"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "npm registry"
      via: "npm publish with OIDC id-token"
      pattern: "id-token: write"
    - from: ".github/workflows/release.yml"
      to: "package.json version"
      via: "Tag-version validation script"
      pattern: "TAG_VERSION.*PKG_VERSION"
    - from: ".github/workflows/release.yml"
      to: "GitHub Releases"
      via: "softprops/action-gh-release@v2"
      pattern: "action-gh-release"
---

<objective>
Create the release workflow that publishes to npm with OIDC provenance on version tag push, make the repo public, set up branch protection, and document the Trusted Publishing setup steps.

Purpose: Automated, verified npm publishing with cryptographic provenance — zero static secrets, tag-to-publish pipeline.
Output: `.github/workflows/release.yml`, public repo, branch protection ruleset, Trusted Publishing instructions for user
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-ci-cd-pipeline/14-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release workflow and configure repository</name>
  <files>.github/workflows/release.yml</files>
  <action>
**1. Create `.github/workflows/release.yml`:**

```yaml
name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Validate version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match package.json ($PKG_VERSION)"
            exit 1
          fi

      - name: Typecheck
        run: bun run typecheck

      - name: Lint
        run: bunx biome ci --error-on-warnings .

      - name: Test
        run: bun run test

      - uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Publish to npm
        run: npm publish --provenance --access public

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
```

Key details per locked decisions and research:
- Triggered on `push tags: ['v*.*.*']` (semver tags only, not broad `v*`)
- `workflow_dispatch` included as fallback trigger for manual re-runs (discretion: include)
- `permissions.id-token: write` — REQUIRED for OIDC Trusted Publishing. Without it, publishing fails with token errors
- `permissions.contents: write` — required for GitHub Release creation
- Build with `bun run build` (tsdown), install with `bun install --frozen-lockfile`
- Version validation: 4-line shell script compares tag `vX.Y.Z` against package.json `version` field (discretion: include)
- Quality re-run: typecheck + lint + test before publish as safety net (discretion: include, ~15s cost)
- `actions/setup-node@v4` with `node-version: '24'` (Node 24 bundles npm 11 natively — no need for `npm install -g npm@latest`)
- Do NOT set `registry-url` in setup-node — it creates .npmrc that conflicts with OIDC (Research pitfall 3)
- Do NOT set `NODE_AUTH_TOKEN` — OIDC handles auth automatically (Research pitfall 3)
- `npm publish --provenance --access public` — provenance for cryptographic attestation, --access public for scoped/new packages
- `softprops/action-gh-release@v2` with `generate_release_notes: true` — auto-generates release notes from commits/PRs (discretion: include)

**2. Make repository public:**

Run: `gh repo edit sh3rd3n/megazord --visibility public`

This is REQUIRED for npm provenance attestation (Research pitfall 1). The user locked OIDC + provenance, which requires a public repo. This is irreversible if the repo gets forks/dependents — note this in the output but proceed (user decision is locked).

**3. Set up branch protection ruleset:**

Run:
```bash
gh api --method POST repos/sh3rd3n/megazord/rulesets \
  --input - <<'EOF'
{
  "name": "master-protection",
  "target": "branch",
  "enforcement": "active",
  "conditions": {
    "ref_name": {
      "include": ["refs/heads/master"],
      "exclude": []
    }
  },
  "rules": [
    {
      "type": "deletion"
    },
    {
      "type": "non_fast_forward"
    },
    {
      "type": "required_status_checks",
      "parameters": {
        "strict_required_status_checks_policy": false,
        "required_status_checks": [
          {
            "context": "Quality"
          }
        ]
      }
    }
  ]
}
EOF
```

Details:
- Branch is `master` (not `main`) — matches actual default branch
- `deletion` rule prevents branch deletion
- `non_fast_forward` prevents force pushes per locked decision
- `required_status_checks` with context `Quality` — matches the CI job `name: Quality` from 14-01's ci.yml
- `strict_required_status_checks_policy: false` — does not require the branch to be up-to-date before merge
- No "restrict pushes" rule — direct pushes to master remain allowed per locked decision (solo developer)
  </action>
  <verify>
1. `ls .github/workflows/release.yml` — file exists
2. `grep 'id-token: write' .github/workflows/release.yml` — OIDC permission present
3. `grep 'npm publish --provenance' .github/workflows/release.yml` — provenance flag present
4. `grep "setup-node@v4" .github/workflows/release.yml` — correct action version
5. `grep "node-version: '24'" .github/workflows/release.yml` — correct Node version
6. `grep -v "registry-url" .github/workflows/release.yml` — no registry-url (would conflict with OIDC)
7. `gh repo view sh3rd3n/megazord --json visibility -q '.visibility'` — returns "PUBLIC"
8. `gh api repos/sh3rd3n/megazord/rulesets` — returns the master-protection ruleset
  </verify>
  <done>
Release workflow exists with OIDC provenance, tag-version validation, quality re-run, and GitHub Release creation. Repository is public. Branch protection ruleset prevents force push and requires CI to pass.
  </done>
</task>

<task type="checkpoint:human-action" gate="non-blocking">
  <name>Task 2: Configure npm Trusted Publishing (after first manual publish)</name>
  <files>n/a — human-only dashboard configuration on npmjs.com</files>
  <action>
The release workflow is configured for OIDC Trusted Publishing. However, Trusted Publishing has a chicken-and-egg problem: the package must exist on npmjs.com BEFORE the connection can be configured. The first publish MUST be done manually (Phase 15).

**This checkpoint documents the step-by-step instructions per locked decision.** Actual execution happens during Phase 15.

**Step-by-step Trusted Publishing configuration on npmjs.com:**

1. **First publish (Phase 15):** Run `npm publish --access public` locally (requires npm login + 2FA)

2. **Go to:** https://www.npmjs.com/package/megazord-cli/access

3. **Find:** "Publishing access" section, then "Trusted Publisher"

4. **Click:** "GitHub Actions" then "Set up connection"

5. **Fill in the form:**
   - Organization or user: `Sh3rd3n` (case-sensitive — must match GitHub exactly, capital S)
   - Repository: `megazord`
   - Workflow filename: `release.yml` (just the filename, NOT `.github/workflows/release.yml`)
   - Environment: (leave empty — we are not using GitHub environments)

6. **Click:** "Set up connection" to save

7. **Verify:** Push a test tag (e.g., `v1.0.1`) and check that the release workflow publishes successfully without any npm token

8. **Optional security hardening:** Under publishing access, enable "Require two-factor authentication and disallow tokens" — this locks down the package to OIDC-only publishing (since OIDC replaces all static tokens)

**Note on owner casing:** GitHub shows the owner as `Sh3rd3n` (capital S). The npm OIDC configuration is case-sensitive. If publishing fails with an OIDC error, try `sh3rd3n` (lowercase) instead.
  </action>
  <verify>This is a non-blocking checkpoint. Verify during Phase 15 by pushing a test tag and confirming the release workflow publishes to npm without static tokens.</verify>
  <done>Trusted Publishing instructions documented and presented to user. Actual configuration deferred to Phase 15 (after first manual publish).</done>
</task>

</tasks>

<verification>
1. `.github/workflows/release.yml` exists with correct YAML structure
2. Workflow triggers on `push tags: ['v*.*.*']` and `workflow_dispatch`
3. Permissions include `id-token: write` and `contents: write`
4. Build/test uses `oven-sh/setup-bun@v2`, publish uses `actions/setup-node@v4`
5. `npm publish --provenance --access public` present (no `registry-url`, no `NODE_AUTH_TOKEN`)
6. Version validation step compares tag against package.json
7. Quality checks (typecheck, lint, test) re-run before publish
8. GitHub Release created via `softprops/action-gh-release@v2`
9. Repository is public (visible at https://github.com/sh3rd3n/megazord)
10. Branch protection ruleset active on `master` — no force push, CI required for PRs, direct push allowed
</verification>

<success_criteria>
- Release workflow file is syntactically valid YAML
- OIDC permissions correctly configured (id-token: write, no registry-url, no NODE_AUTH_TOKEN)
- Tag-version validation catches mismatches
- Repository is public (required for provenance)
- Branch protection prevents force push and requires CI status check
- Trusted Publishing instructions are clear and actionable for Phase 15
</success_criteria>

<output>
After completion, create `.planning/phases/14-ci-cd-pipeline/14-02-SUMMARY.md`
</output>
