---
phase: 06-agent-teams-integration
plan: 03
type: execute
wave: 2
depends_on:
  - "06-01"
  - "06-02"
files_modified:
  - skills/go/SKILL.md
  - skills/go/teams.md
  - skills/go/executor.md
  - hooks/hooks.json
  - scripts/enforce-ownership.sh
  - skills/help/SKILL.md
autonomous: true
requirements:
  - AGNT-01
  - AGNT-03
  - AGNT-04
  - AGNT-05
  - AGNT-06
  - AGNT-07
  - AGNT-08

must_haves:
  truths:
    - "/mz:go auto-detects whether to use subagents or Agent Teams based on plan complexity, with --teams/--no-teams overrides"
    - "Agent Teams mode creates a team per wave with worktree-isolated teammates coordinated by a delegate-mode lead"
    - "Reviewer sends code back to implementer via SendMessage with actionable feedback and re-reviews after fixes"
    - "File ownership hook blocks unauthorized file modifications during Agent Teams execution"
    - "Silent fallback to subagents if Agent Teams fails (creation error, API unavailable)"
  artifacts:
    - path: "skills/go/SKILL.md"
      provides: "Full /mz:go skill with hybrid detection, Agent Teams path, delegate mode, wave-level team lifecycle"
      contains: "Agent Teams"
    - path: "skills/go/teams.md"
      provides: "Agent Teams execution reference: team lifecycle, spawning, communication, merge protocol"
      contains: "TeamCreate"
    - path: "skills/go/executor.md"
      provides: "Updated execution protocol with dual-mode spawning (subagent and teammate)"
      contains: "teammate"
    - path: "hooks/hooks.json"
      provides: "PreToolUse hook for file ownership enforcement"
      contains: "PreToolUse"
    - path: "scripts/enforce-ownership.sh"
      provides: "Hook script that validates file access against ownership manifest"
      contains: "ownership"
    - path: "skills/help/SKILL.md"
      provides: "Updated help with Agent Teams flags and phase 6 description"
      contains: "--teams"
  key_links:
    - from: "skills/go/SKILL.md"
      to: "skills/go/teams.md"
      via: "@-reference for Agent Teams protocol"
      pattern: "@skills/go/teams.md"
    - from: "skills/go/SKILL.md"
      to: "skills/go/executor.md"
      via: "@-reference for execution protocol"
      pattern: "@skills/go/executor.md"
    - from: "hooks/hooks.json"
      to: "scripts/enforce-ownership.sh"
      via: "PreToolUse hook command reference"
      pattern: "enforce-ownership"
    - from: "scripts/enforce-ownership.sh"
      to: "src/lib/ownership.ts"
      via: "reads ownership.json manifest generated by ownership.ts"
      pattern: "ownership.json"
---

<objective>
Integrate Agent Teams into the /mz:go skill with hybrid detection, per-wave team lifecycle, delegate mode, worktree isolation, file ownership enforcement hook, and updated help documentation.

Purpose: This is the core integration plan. It rewrites /mz:go to support two execution paths (subagents and Agent Teams), creates the Agent Teams protocol reference, adds the PreToolUse file ownership hook, and updates all supporting documentation.

Output: Rewritten /mz:go skill with dual execution paths, teams.md reference, ownership hook, and updated help.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-teams-integration/06-RESEARCH.md
@.planning/phases/06-agent-teams-integration/06-CONTEXT.md
@.planning/phases/06-agent-teams-integration/06-01-SUMMARY.md
@.planning/phases/06-agent-teams-integration/06-02-SUMMARY.md
@skills/go/SKILL.md
@skills/go/executor.md
@skills/help/SKILL.md
@hooks/hooks.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite /mz:go skill with hybrid detection and Agent Teams execution path</name>
  <files>
    skills/go/SKILL.md
    skills/go/teams.md
    skills/go/executor.md
  </files>
  <action>
**Rewrite `skills/go/SKILL.md`** to add hybrid execution detection and Agent Teams path. The existing subagent path (Steps 1-8) remains functional but is wrapped in a mode decision. Target ~500 lines (was ~346).

Keep the existing frontmatter, header, and design system reference. Add reference to `@skills/go/teams.md` for Agent Teams protocol.

**Step 1: Display Banner** -- unchanged.

**Step 2: Load Context and Validate** -- extend to:
- Parse existing flags (--tasks, --from, --dry-run)
- Add new flags: `--teams` (force Agent Teams mode), `--no-teams` (force subagent mode)
- Load config, including `config.agent_teams.enabled` (auto/always/never)
- Load review config (unchanged from current)
- Resolve plugin path (unchanged)

**Step 3: Find Plans** -- unchanged (list, incomplete, waves, conflicts).

**Step 4: Apply Execution Filters** -- unchanged (--tasks, --from, --dry-run).

**NEW Step 5: Determine Execution Mode** -- This is the hybrid detection step.

Detection logic (check in order):
1. If `--teams` flag: mode = "teams" (force)
2. If `--no-teams` flag: mode = "subagents" (force)
3. If `config.agent_teams.enabled === "always"`: mode = "teams"
4. If `config.agent_teams.enabled === "never"`: mode = "subagents"
5. If `config.agent_teams.enabled === "auto"`: auto-detect per wave:
   - For each wave, examine the plans in that wave:
     - If review is enabled AND the wave has 2+ plans: mode = "teams" (review loops benefit from communication)
     - If the wave has plans with inter-plan dependencies (plans in this wave depend on each other -- unusual but possible via file overlap): mode = "teams"
     - Otherwise: mode = "subagents"

Display the chosen mode:
```
> Execution Mode: {Agent Teams | Subagents}
  {Reason: auto-detect / --teams flag / config}
```

If Agent Teams mode selected, verify availability:
- Check if `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS` environment variable is set (the skill reads it via Bash: `echo $CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS`).
- If not available: silently fall back to subagents. Display: `> Mode: Subagents (Agent Teams not available)`

**Step 6: Execute Waves** -- split into two paths based on mode:

**Path A: Subagent Execution** (existing behavior, verbatim from current Steps 5-7):
Same as current SKILL.md Steps 5-7. No changes. Include all existing content for spawning, completion parsing, state updates, failure handling.

**Path B: Agent Teams Execution** (new, reference `@skills/go/teams.md` for full protocol):

For each wave:
1. **Create worktrees** for each plan in the wave:
   ```bash
   node {plugin_path}/bin/megazord.mjs tools worktree create --team {team_name} --agent exec-{plan_id}
   ```
   Team name format: `mz-{phase}-w{wave}` (e.g., `mz-06-w1`).

2. **Generate ownership manifest:**
   Read each plan's `files_modified` frontmatter. Build the ownership manifest mapping each agent name to its declared files. Write to a temporary file that the hook can read.

3. **Write agent context files:**
   For each worktree, write `.mz-agent-context.json` inside the worktree directory containing: `{ "agent_name": "exec-{plan_id}", "team_name": "{team_name}", "team_lead": "mz-lead", "owned_files": [...] }`. This file is read by the ownership enforcement hook (since environment variables cannot be set for teammates).

4. **Create team:**
   ```
   TeamCreate({ team_name: "{team_name}", description: "Phase {N} Wave {W}" })
   ```

5. **Create tasks:**
   For each plan, create a task via TaskCreate with the plan content embedded as description.

6. **Spawn teammates:**
   For each plan, spawn an executor teammate. If review is enabled, also spawn a reviewer teammate.
   - Read agent definitions (mz-executor.md, mz-reviewer.md) and embed inline.
   - Executor prompt includes: agent role, plan content, config, execution_rules with `execution_mode: teammate`, `worktree_path`, `owned_files`, `team_lead`, `reviewer_name` (if review enabled), `task_id`.
   - Reviewer prompt includes: agent role, review config, `review_mode_type: teammate`, `worktree_paths` (map of agent names to worktree paths), `team_lead`.

7. **DELEGATE MODE: Coordinate only.**
   After spawning, the lead (this skill) enters coordination mode:
   - Do NOT use Edit, Write, or Bash for implementation.
   - Monitor via TaskList for task completion.
   - Messages from teammates arrive automatically.
   - If a reviewer escalates (max rounds), log the escalation.
   - If an executor reports failure, save error output.
   - Wait until all tasks in the wave are completed or failed.

8. **Merge worktrees** (sequential, in plan order):
   For each completed plan:
   ```bash
   node {plugin_path}/bin/megazord.mjs tools worktree merge --team {team_name} --agent exec-{plan_id} --strategy merge
   ```
   If merge fails (conflicts): stop the wave, leave worktree for inspection, log the conflict.

9. **Shutdown teammates:**
   For each teammate: `SendMessage({ type: "shutdown_request", recipient: "{name}", content: "Wave complete" })`.
   Wait for responses (timeout 60s, proceed anyway if no response).

10. **Cleanup:**
    ```bash
    node {plugin_path}/bin/megazord.mjs tools worktree prune --team {team_name}
    ```
    Then `TeamDelete()` to remove team resources.

11. **Update state** (same as subagent path: advance plan, record metrics, add decisions, update session).

12. **Silent fallback:** If ANY of steps 1-6 fail (TeamCreate fails, worktree creation fails), catch the error and fall back to subagent path for this wave. Log: `[TEAMS FALLBACK] {reason}. Using subagent mode for wave {N}.`

**Step 7: Update Roadmap** -- unchanged.
**Step 8: Check for Unresolved Review Findings** -- unchanged.
**Step 9: Post-Execution Summary** -- extend to show execution mode used per wave.

**Add `--teams` and `--no-teams` to the Usage examples** in the Notes section.

**Create `skills/go/teams.md`** (~200 lines) as the Agent Teams execution reference (like executor.md is the subagent execution reference):

Document the full Agent Teams lifecycle:
1. **Team Naming:** `mz-{phase}-w{wave}` format
2. **Worktree Setup:** One per agent, created before team
3. **Ownership Manifest:** Generated from plan frontmatter, written to team directory
4. **Agent Context Files:** `.mz-agent-context.json` in each worktree for hook consumption
5. **Team Creation:** TeamCreate with shared task list
6. **Task Population:** TaskCreate for each plan
7. **Teammate Spawning:** Task tool with team_name parameter, inline agent definitions
8. **Delegate Mode:** Lead coordinates only -- never implements
9. **Communication Protocol:**
   - Executor -> Reviewer: "Task complete, ready for review" via SendMessage
   - Reviewer -> Executor: feedback findings via SendMessage
   - Reviewer -> Lead: escalation after max rounds via SendMessage
   - Executor -> Lead: completion/failure notification via SendMessage
10. **Merge Protocol:** Sequential merge, no-ff, in plan order, stop on conflict
11. **Shutdown Flow:** Sequential shutdown_request, 60s timeout, proceed anyway
12. **Cleanup:** Prune worktrees, delete team
13. **Silent Fallback:** Any failure -> subagent path, log reason
14. **State Update Protocol:** Same as subagent path (orchestrator-only)

**Update `skills/go/executor.md`** to add a section on Agent Teams spawning alongside the existing subagent spawning documentation:

Add "## Agent Teams Spawning Protocol" section:
- Reference `@skills/go/teams.md` for full lifecycle
- Executor prompt structure for teammate mode (same sections as subagent mode, plus execution_mode, worktree_path, owned_files, team_lead, reviewer_name, task_id)
- Reviewer prompt structure for teammate mode
- Responsibility table update: add "Claim task via TaskUpdate" (Executor), "Merge worktree" (Orchestrator), "Manage team lifecycle" (Orchestrator)
  </action>
  <verify>
Check file sizes and key content:
```bash
wc -l skills/go/SKILL.md          # Expect ~450-550 lines
wc -l skills/go/teams.md          # Expect ~180-220 lines
wc -l skills/go/executor.md       # Expect ~200-250 lines
grep -c "Agent Teams" skills/go/SKILL.md    # Expect 5+
grep -c "TeamCreate" skills/go/SKILL.md     # Expect 1+
grep -c "subagent" skills/go/SKILL.md       # Expect 3+
grep -c "--teams" skills/go/SKILL.md        # Expect 2+
grep -c "delegate" skills/go/SKILL.md       # Expect 1+
grep -c "SendMessage" skills/go/teams.md    # Expect 3+
grep -c "worktree" skills/go/teams.md       # Expect 5+
```
  </verify>
  <done>/mz:go skill supports hybrid execution (auto-detect, --teams, --no-teams). Agent Teams path includes per-wave team lifecycle with worktree isolation, delegate mode, SendMessage communication, sequential merge, graceful shutdown, and silent fallback. teams.md documents the full protocol. executor.md covers dual-mode spawning.</done>
</task>

<task type="auto">
  <name>Task 2: Create file ownership enforcement hook and update help</name>
  <files>
    hooks/hooks.json
    scripts/enforce-ownership.sh
    skills/help/SKILL.md
  </files>
  <action>
**Create `scripts/enforce-ownership.sh`:**

```bash
#!/bin/bash
# File ownership enforcement for Megazord Agent Teams
# PreToolUse hook: blocks or warns when agents modify files outside their declared scope
# Reads agent context from .mz-agent-context.json in the project directory

INPUT=$(cat)
FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // .tool_input.file // empty')
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty')

# Only enforce for Edit and Write tools
if [ "$TOOL_NAME" != "Edit" ] && [ "$TOOL_NAME" != "Write" ]; then
  exit 0
fi

# Skip if no file path (shouldn't happen for Edit/Write)
if [ -z "$FILE_PATH" ]; then
  exit 0
fi

# Look for agent context file in the current project directory
CONTEXT_FILE="${CLAUDE_PROJECT_DIR:-.}/.mz-agent-context.json"
if [ ! -f "$CONTEXT_FILE" ]; then
  exit 0  # Not in Agent Teams mode, allow everything
fi

AGENT_NAME=$(jq -r '.agent_name // empty' "$CONTEXT_FILE")
if [ -z "$AGENT_NAME" ]; then
  exit 0  # No agent name, allow
fi

# Read owned files from context
OWNED_FILES=$(jq -r '.owned_files // [] | .[]' "$CONTEXT_FILE")
if [ -z "$OWNED_FILES" ]; then
  exit 0  # No file restrictions, allow
fi

# Normalize file path: strip absolute prefix to get relative path
# Handle both absolute paths and relative paths
NORM_PATH="$FILE_PATH"
if [[ "$NORM_PATH" == /* ]]; then
  # Try to make relative to project dir
  PROJECT_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}"
  NORM_PATH="${NORM_PATH#$PROJECT_DIR/}"
fi
# Also strip leading ./
NORM_PATH="${NORM_PATH#./}"

# Check if the file is in the agent's declared scope (prefix match)
ALLOWED=false
while IFS= read -r owned; do
  if [ -z "$owned" ]; then continue; fi
  if [[ "$NORM_PATH" == "$owned" ]] || [[ "$NORM_PATH" == "$owned"/* ]]; then
    ALLOWED=true
    break
  fi
done <<< "$OWNED_FILES"

if [ "$ALLOWED" = false ]; then
  # Check strict mode from context file
  STRICT=$(jq -r '.strict_ownership // false' "$CONTEXT_FILE")

  SCOPE_LIST=$(jq -r '.owned_files // [] | join(", ")' "$CONTEXT_FILE")

  if [ "$STRICT" = "true" ]; then
    echo "OWNERSHIP VIOLATION: Agent '$AGENT_NAME' attempted to modify '$NORM_PATH' which is outside its declared scope." >&2
    echo "Declared files: $SCOPE_LIST" >&2
    exit 2  # Hard block
  else
    # Advisory mode: warn but allow
    echo "OWNERSHIP WARNING: Agent '$AGENT_NAME' is modifying '$NORM_PATH' outside its declared scope ($SCOPE_LIST). Proceeding (advisory mode)." >&2
    exit 0
  fi
fi

exit 0
```

Make it executable: the executor should run `chmod +x scripts/enforce-ownership.sh` after creating the file.

**Update `hooks/hooks.json`:**

Replace the current empty hooks with the PreToolUse ownership enforcement hook:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/enforce-ownership.sh"
          }
        ]
      }
    ]
  }
}
```

Note: `${CLAUDE_PLUGIN_ROOT}` is the plugin's root directory, resolved by Claude Code at runtime. This ensures the hook works regardless of where the plugin is installed.

IMPORTANT: Verify `CLAUDE_PLUGIN_ROOT` is the correct environment variable for plugin hook scripts. If the existing hooks pattern uses a different path resolution (check Phase 1 hooks setup), match that pattern. The research suggests using the plugin root variable. If unsure, use a relative path from the hooks directory or an absolute path pattern like `$HOME/.claude/plugins/mz/scripts/enforce-ownership.sh`.

**Update `skills/help/SKILL.md`:**

1. Update the `/mz:go` row in the Available Skills table:
   - Description: `Execute the current phase plan (subagent or Agent Teams mode)`

2. Add new usage examples under the Usage section:
   ```
   /mz:go --teams      Force Agent Teams mode (requires experimental flag)
   /mz:go --no-teams   Force subagent mode (skip Agent Teams)
   ```

3. Update the phase line at the bottom: `**Phase:** 6 of 8 (Agent Teams Integration)`

4. Keep the count at 11 Available skills, 3 Coming soon (no new skills added in this phase -- the same 11 skills are enhanced).
  </action>
  <verify>
```bash
# Verify hook script exists and is executable
test -f scripts/enforce-ownership.sh && echo "exists" || echo "missing"
test -x scripts/enforce-ownership.sh && echo "executable" || echo "not executable"

# Verify hooks.json has PreToolUse
grep -c "PreToolUse" hooks/hooks.json         # Expect 1
grep -c "enforce-ownership" hooks/hooks.json  # Expect 1

# Verify help updates
grep -c "\-\-teams" skills/help/SKILL.md      # Expect 2+
grep "Phase:" skills/help/SKILL.md            # Expect "Phase: 6 of 8"
```
  </verify>
  <done>PreToolUse file ownership enforcement hook is installed (scripts/enforce-ownership.sh) and registered in hooks.json. Hook supports both advisory (default) and strict modes based on agent context file. Help skill updated with Agent Teams flags and Phase 6 description.</done>
</task>

</tasks>

<verification>
- skills/go/SKILL.md contains hybrid detection logic (auto-detect, --teams, --no-teams, config.agent_teams.enabled)
- skills/go/SKILL.md contains both subagent execution path and Agent Teams execution path
- skills/go/teams.md documents the full Agent Teams lifecycle (13 sections)
- skills/go/executor.md documents both subagent and teammate spawning protocols
- hooks/hooks.json has PreToolUse hook for Edit|Write
- scripts/enforce-ownership.sh is executable and reads .mz-agent-context.json
- skills/help/SKILL.md shows Phase 6, --teams/--no-teams flags
- Silent fallback is documented and implemented in the skill
</verification>

<success_criteria>
/mz:go automatically selects subagent or Agent Teams execution based on plan complexity, with flag overrides. Agent Teams mode creates per-wave teams with worktree-isolated teammates, delegate-mode lead coordination, reviewer-implementer SendMessage feedback loops, sequential merge, and graceful shutdown. File ownership is enforced via PreToolUse hook. Fallback to subagents is silent on any Agent Teams failure.
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-teams-integration/06-03-SUMMARY.md`
</output>
