---
phase: 09-config-consumption-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/config.ts
  - src/lib/ownership.ts
  - agents/mz-researcher.md
  - agents/mz-planner.md
  - agents/mz-executor.md
  - agents/mz-reviewer.md
  - agents/mz-verifier.md
  - agents/mz-mapper.md
autonomous: true
requirements:
  - CONF-03

must_haves:
  truths:
    - "resolveAgentModel('quality', 'executor') returns 'opus'"
    - "resolveAgentModel('balanced', 'planner') returns 'opus' (differentiated profile)"
    - "resolveAgentModel('budget', 'researcher') returns 'haiku'"
    - "Per-agent model_overrides take precedence over profile mapping"
    - "ownership.ts is completely removed from the codebase with zero references"
    - "All 6 agent .md files have a valid 'model' field in YAML frontmatter"
  artifacts:
    - path: "src/lib/config.ts"
      provides: "model_overrides schema, resolveAgentModel() function, BALANCED_MODEL_MAP"
      contains: "resolveAgentModel"
    - path: "agents/mz-researcher.md"
      provides: "Agent definition with model frontmatter"
      contains: "model: inherit"
    - path: "agents/mz-executor.md"
      provides: "Agent definition with model frontmatter"
      contains: "model: inherit"
  key_links:
    - from: "src/lib/config.ts"
      to: "megazord.config.json"
      via: "model_overrides optional field in configSchema"
      pattern: "model_overrides"
---

<objective>
Extend the config schema with model override support, add the model resolution function, add model frontmatter to all agent files, and delete dead code.

Purpose: Establishes the foundation that all skill wiring (Plan 09-02 and 09-03) depends on -- the model resolution logic and agent frontmatter that makes model selection work.
Output: Updated config.ts with resolveAgentModel(), 6 agent .md files with model frontmatter, ownership.ts deleted.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/config.ts
@src/lib/ownership.ts
@agents/mz-researcher.md
@agents/mz-planner.md
@agents/mz-executor.md
@agents/mz-reviewer.md
@agents/mz-verifier.md
@agents/mz-mapper.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add model_overrides schema and resolveAgentModel() to config.ts, add model frontmatter to agent files</name>
  <files>
    src/lib/config.ts
    agents/mz-researcher.md
    agents/mz-planner.md
    agents/mz-executor.md
    agents/mz-reviewer.md
    agents/mz-verifier.md
    agents/mz-mapper.md
  </files>
  <action>
In `src/lib/config.ts`:

1. Add a `modelOverridesSchema` after the existing sub-schemas section:
   ```typescript
   /** Per-agent model overrides — optional, override wins over profile */
   export const modelOverridesSchema = z.record(
     z.enum(["researcher", "planner", "executor", "reviewer", "verifier", "mapper"]),
     z.enum(["opus", "sonnet", "haiku", "inherit"]),
   ).optional();
   ```

2. Add `model_overrides` field to `configSchema` after the `model_profile` field:
   ```typescript
   /** Per-agent model overrides (optional, override wins over profile) */
   model_overrides: modelOverridesSchema.default({}),
   ```
   Note: Use `.default({})` so the field is always present in the parsed config.

3. Add the model resolution logic as exported constants and function BEFORE the Load/Save utilities section:
   ```typescript
   // ─── Model resolution ──────────────────────────────────────────────────────

   /** Agent roles that support model selection */
   export type AgentRole = "researcher" | "planner" | "executor" | "reviewer" | "verifier" | "mapper";

   /** Uniform profile-to-model mapping (all agents same model) */
   const UNIFORM_MODEL_MAP: Record<string, string> = {
     quality: "opus",
     balanced: "sonnet",
     budget: "haiku",
   };

   /**
    * Differentiated "balanced" profile: planner gets opus for higher-quality
    * reasoning, all others get sonnet. Quality and budget profiles remain uniform.
    */
   const BALANCED_PLANNER_MODEL = "opus";
   const BUDGET_PLANNER_MODEL = "sonnet";

   /**
    * Resolve the model for a specific agent role based on profile and overrides.
    *
    * Precedence: model_overrides[role] > profile mapping.
    * Override "inherit" means "use profile mapping" (same as no override).
    */
   export function resolveAgentModel(
     config: MegazordConfig,
     agentRole: AgentRole,
   ): string {
     // 1. Check per-agent override (override wins, period)
     const override = config.model_overrides?.[agentRole];
     if (override && override !== "inherit") {
       return override;
     }

     // 2. Differentiated profiles for specific roles
     const profile = config.model_profile;
     if (profile === "balanced" && agentRole === "planner") {
       return BALANCED_PLANNER_MODEL;
     }
     if (profile === "budget" && agentRole === "planner") {
       return BUDGET_PLANNER_MODEL;
     }

     // 3. Uniform mapping
     return UNIFORM_MODEL_MAP[profile] ?? "opus";
   }
   ```

4. Update the `presets` object: add `model_overrides: {}` to each preset (strict, balanced, minimal) so they include the new field.

For all 6 agent `.md` files (`agents/mz-researcher.md`, `agents/mz-planner.md`, `agents/mz-executor.md`, `agents/mz-reviewer.md`, `agents/mz-verifier.md`, `agents/mz-mapper.md`):

Add YAML frontmatter at the top of each file. The existing content starts with `# Megazord ...` -- prepend the frontmatter block BEFORE the existing content. Use `model: inherit` as the default (the orchestrator skills will rewrite this dynamically before spawning).

Example for mz-researcher.md:
```yaml
---
name: mz-researcher
description: Research the technical landscape for a phase before planning
model: inherit
tools: Read, Grep, Glob, Bash, Write, Edit, WebSearch, WebFetch
---

# Megazord Phase Researcher
...existing content...
```

Agent frontmatter values:
- `mz-researcher`: name=mz-researcher, description="Research the technical landscape for a phase before planning", tools="Read, Grep, Glob, Bash, Write, Edit, WebSearch, WebFetch"
- `mz-planner`: name=mz-planner, description="Decompose a phase into executable plans with tasks and dependencies", tools="Read, Grep, Glob, Bash, Write, Edit"
- `mz-executor`: name=mz-executor, description="Execute a single plan file with atomic commits per task", tools="Read, Grep, Glob, Bash, Write, Edit"
- `mz-reviewer`: name=mz-reviewer, description="Two-stage code review for spec compliance and code quality", tools="Read, Grep, Glob, Bash, Write, Edit"
- `mz-verifier`: name=mz-verifier, description="Goal-backward phase verification against success criteria", tools="Read, Grep, Glob, Bash, Write, Edit"
- `mz-mapper`: name=mz-mapper, description="Analyze an existing codebase for brownfield project support", tools="Read, Grep, Glob, Bash, Write, Edit"

All agents get `model: inherit` as default. The orchestrator skills will dynamically update this field before spawning.
  </action>
  <verify>
    - `bun run typecheck` passes (no TypeScript errors from schema changes)
    - `bun run build` succeeds
    - Grep for `resolveAgentModel` in config.ts confirms the function exists
    - Grep for `model_overrides` in config.ts confirms the schema field exists
    - Each agent .md file starts with `---` (has YAML frontmatter)
    - Each agent .md file contains `model: inherit`
  </verify>
  <done>
    - resolveAgentModel() exported from config.ts with correct profile->model mapping
    - model_overrides field in configSchema with record of agent role -> model enum
    - All 6 agent files have proper YAML frontmatter with name, description, model, tools fields
    - Differentiated balanced profile: planner->opus, others->sonnet
    - Budget differentiated profile: planner->sonnet, others->haiku
    - Override precedence: override wins over profile, "inherit" defers to profile
    - TypeScript compiles, build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete ownership.ts and verify no dead code references remain</name>
  <files>src/lib/ownership.ts</files>
  <action>
1. Delete `src/lib/ownership.ts` entirely (the file is confirmed 100% dead -- zero imports anywhere in the codebase).

2. Run a broad dead code scan:
   - `grep -rn "ownership" --include="*.ts" --include="*.md" --include="*.json"` across the entire project (excluding node_modules, .git, dist).
   - Check results: if any file imports from `./ownership` or references `OwnershipManifest`, `generateOwnershipManifest`, `writeOwnershipManifest`, or `validateFileAccess`, remove those references.
   - Note: The ownership ENFORCEMENT (scripts/enforce-ownership.sh and .mz-agent-context.json) is NOT dead code -- it works via shell hook, not TypeScript imports. Do not touch these.

3. Check for any other dead exports across `src/lib/*.ts`:
   - For each exported function/type in src/lib/ files, verify at least one import exists outside the file itself.
   - If any purely dead exports are found (zero external imports), remove them.
   - Note: Do NOT do a full codebase audit (deferred to a future phase). Only check src/lib/ files since they are the shared library layer.

4. Verify after cleanup:
   - `bun run typecheck` passes
   - `bun run build` succeeds
   - No broken imports

5. Opportunistic fix: If any files touched during the dead code scan have obvious issues (unused imports, broken references), fix them inline. Do NOT go searching for issues in files not already being examined.
  </action>
  <verify>
    - `src/lib/ownership.ts` does not exist on disk
    - `grep -rn "ownership" --include="*.ts" src/` returns zero results referencing the deleted module (references to the shell-based ownership enforcement in non-ts files are fine)
    - `bun run typecheck` passes
    - `bun run build` succeeds
  </verify>
  <done>
    - ownership.ts fully deleted with zero remaining TypeScript references
    - No new dead exports discovered (or any found are removed)
    - Build and typecheck both pass cleanly
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors (`bun run typecheck`)
- Build succeeds (`bun run build`)
- All 6 agent files have YAML frontmatter with model field
- resolveAgentModel() produces correct outputs for all 3 profiles and override scenarios
- ownership.ts is gone and no dead references remain
- Config schema accepts the new model_overrides field
</verification>

<success_criteria>
- The config schema supports model_overrides as an optional record of agent role -> model
- resolveAgentModel() correctly maps profiles to models with differentiated balanced/budget handling
- All agent .md files have frontmatter enabling dynamic model selection
- ownership.ts is fully removed from the codebase
- The project builds and typechecks cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-consumption-wiring/09-01-SUMMARY.md`
</output>
