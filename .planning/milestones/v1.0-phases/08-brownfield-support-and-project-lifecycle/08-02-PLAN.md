---
phase: 08-brownfield-support-and-project-lifecycle
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/roadmap.ts
  - src/lib/milestone.ts
  - src/cli/commands/roadmap-tools.ts
  - src/cli/commands/milestone-tools.ts
autonomous: true
requirements:
  - PROJ-09

must_haves:
  truths:
    - "Phase add command creates a new integer phase at the end of the roadmap with directory"
    - "Phase remove command removes a future unstarted phase and renumbers subsequent phases"
    - "Phase insert command creates a decimal phase between existing phases without renumbering"
    - "Milestone archive copies roadmap and requirements to milestones directory with version prefix"
    - "Milestone audit check verifies that all phases in the milestone have passing verification"
    - "Verification gate check confirms previous phase has VERIFICATION.md with passed status"
  artifacts:
    - path: "src/lib/roadmap.ts"
      provides: "Roadmap parsing and phase management functions"
      min_lines: 120
      exports: ["addPhase", "removePhase", "insertPhase", "parseRoadmapPhases", "checkVerificationGate"]
    - path: "src/lib/milestone.ts"
      provides: "Milestone CRUD, archive, and audit helpers"
      min_lines: 100
      exports: ["createMilestone", "archiveMilestone", "checkMilestoneAudit"]
    - path: "src/cli/commands/roadmap-tools.ts"
      provides: "CLI commands for phase management"
      min_lines: 60
    - path: "src/cli/commands/milestone-tools.ts"
      provides: "CLI commands for milestone operations"
      min_lines: 60
  key_links:
    - from: "src/cli/commands/roadmap-tools.ts"
      to: "src/lib/roadmap.ts"
      via: "import and invoke phase management functions"
      pattern: "import.*from.*roadmap"
    - from: "src/cli/commands/milestone-tools.ts"
      to: "src/lib/milestone.ts"
      via: "import and invoke milestone functions"
      pattern: "import.*from.*milestone"
    - from: "src/lib/roadmap.ts"
      to: ".planning/ROADMAP.md"
      via: "Read, parse, and modify roadmap file"
      pattern: "ROADMAP\\.md"
---

<objective>
Create the lifecycle management infrastructure: roadmap phase management library (add, remove, insert phases) and milestone lifecycle library (create, archive, audit) with CLI tool commands for both.

Purpose: Provide the mechanical operations for full project lifecycle management -- phase transitions, phase management commands, and milestone workflows -- as reusable library functions exposed through CLI tools.
Output: Two library files (roadmap.ts, milestone.ts) and two CLI command files (roadmap-tools.ts, milestone-tools.ts) registered in the CLI.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-brownfield-support-and-project-lifecycle/08-RESEARCH.md
@.planning/phases/08-brownfield-support-and-project-lifecycle/08-CONTEXT.md

# Prior patterns to follow:
@src/lib/state.ts
@src/lib/plan.ts
@src/cli/commands/state.ts
@src/cli/commands/plan-tools.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create roadmap and milestone library files</name>
  <files>src/lib/roadmap.ts, src/lib/milestone.ts</files>
  <action>
Create `src/lib/roadmap.ts` with these exports, following the exact patterns from `src/lib/state.ts` (synchronous file reads, section-based markdown parsing, fs-extra):

**`parseRoadmapPhases(planningDir: string): RoadmapPhase[]`**
- Parse ROADMAP.md to extract all phases with: number, name, slug, status (completed/in-progress/not-started), goal, requirements, depends_on
- Handle both integer phases (1, 2, 3) and decimal phases (6.1, 6.2)
- Return sorted by phase number

**`addPhase(planningDir: string, description: string, goal?: string): AddPhaseResult`**
- Find highest existing integer phase number in ROADMAP.md
- Create new phase at `maxPhase + 1`
- Generate slug from description (lowercase, hyphens, strip special chars)
- Create phase directory: `.planning/phases/{padded}-{slug}/`
- Insert phase entry into ROADMAP.md in the correct location (after last phase in the phases list, before Progress table)
- Add phase detail section (`### Phase {N}: {Name}`) with Goal (provided or placeholder), Requirements placeholder, Plans placeholder
- Update the Progress table with a new row
- Return `{ phase_number, padded, name, slug, directory }`

**`removePhase(planningDir: string, phaseNumber: number): RemovePhaseResult`**
- Validate: phase must exist, must NOT be completed, must NOT be in-progress
- Remove the phase entry from ROADMAP.md phases list
- Remove the `### Phase {N}` detail section
- Remove the phase directory (if it exists and is empty or has no SUMMARY files)
- Renumber subsequent phases (both directory names and ROADMAP.md references)
- Update the Progress table
- Return `{ removed: number, renumbered: Map<number, number> }`

**`insertPhase(planningDir: string, afterPhase: number, description: string, goal?: string): InsertPhaseResult`**
- Find the next available decimal number after `afterPhase` (e.g., if 6 exists, try 6.1; if 6.1 exists, try 6.2)
- Create phase directory with decimal naming: `.planning/phases/{N}.{M}-{slug}/`
- Insert into ROADMAP.md between `afterPhase` and the next phase, marking with `INSERTED`
- Add phase detail section
- Return `{ phase_number: string, name, slug, directory }`

**`checkVerificationGate(planningDir: string, phaseNumber: number): VerificationGateResult`**
- Check if phase `phaseNumber` has a VERIFICATION.md in its phase directory
- Parse the VERIFICATION.md status (look for `status: passed`, `status: gaps_found`, `status: human_needed`)
- Return `{ exists, status, passed, message }`
- This is used by /mz:plan to enforce the verification gate before planning the next phase

Create `src/lib/milestone.ts` with these exports:

**`createMilestone(planningDir: string, version: string, name: string, phases: number[]): CreateMilestoneResult`**
- Create `MILESTONE.md` in `.planning/` with version, name, phases, status: active, created date
- Return `{ version, name, phases, path }`

**`archiveMilestone(planningDir: string, version: string): ArchiveResult`**
- Create `.planning/milestones/` directory if needed
- Copy ROADMAP.md to `{version}-ROADMAP.md` in milestones/
- Copy REQUIREMENTS.md to `{version}-REQUIREMENTS.md` (if exists) in milestones/
- Optionally copy phase directories to `milestones/{version}-phases/` (preserve, don't delete originals)
- Create/append to `MILESTONES.md` with entry: version, date, phases completed, status
- Create git tag: `milestone/{version}` with descriptive message
- Return `{ version, date, archived: string[] }`

**`checkMilestoneAudit(planningDir: string, phases: number[]): AuditCheckResult`**
- For each phase in the milestone: check VERIFICATION.md exists and status is passed
- Aggregate results: all_passed, failed_phases, missing_verification
- Return `{ all_passed, details: AuditDetail[] }`

Use Zod schemas for all result types. Use `fse.readFileSync` / `fse.writeFileSync` (synchronous) matching the existing `state.ts` pattern. Use `fs-extra` with default import. Generate slugs with a `generateSlug` helper function (lowercase, replace spaces/special chars with hyphens, strip consecutive hyphens).
  </action>
  <verify>
- `src/lib/roadmap.ts` exists and exports `addPhase`, `removePhase`, `insertPhase`, `parseRoadmapPhases`, `checkVerificationGate`
- `src/lib/milestone.ts` exists and exports `createMilestone`, `archiveMilestone`, `checkMilestoneAudit`
- Both files use synchronous I/O (readFileSync/writeFileSync pattern)
- Both files import fs-extra with default import
- `removePhase` validates phase is not completed or in-progress
- `insertPhase` scans for existing decimal phases to avoid collisions
- `checkVerificationGate` parses VERIFICATION.md status
  </verify>
  <done>Roadmap library handles phase add/remove/insert with proper validation, decimal numbering collision avoidance, and ROADMAP.md editing. Milestone library handles create/archive/audit with git tagging and milestones directory management. Verification gate check is available for skill-level enforcement.</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI tool commands and register in CLI</name>
  <files>src/cli/commands/roadmap-tools.ts, src/cli/commands/milestone-tools.ts</files>
  <action>
Create `src/cli/commands/roadmap-tools.ts` following the exact pattern from `src/cli/commands/plan-tools.ts` and `src/cli/commands/state.ts` (Commander subcommands, JSON output, try/catch error wrapping):

Register a `roadmap` subcommand group under `tools`:

**`megazord.mjs tools roadmap list`**
- Call `parseRoadmapPhases(planningDir)`
- Output JSON: `{ phases: RoadmapPhase[] }`

**`megazord.mjs tools roadmap add-phase --description "{desc}" --goal "{goal}"`**
- Call `addPhase(planningDir, description, goal)`
- Output JSON result

**`megazord.mjs tools roadmap remove-phase --phase {N}`**
- Call `removePhase(planningDir, phaseNumber)`
- Output JSON result

**`megazord.mjs tools roadmap insert-phase --after {N} --description "{desc}" --goal "{goal}"`**
- Call `insertPhase(planningDir, afterPhase, description, goal)`
- Output JSON result

**`megazord.mjs tools roadmap check-gate --phase {N}`**
- Call `checkVerificationGate(planningDir, phaseNumber)`
- Output JSON result

Create `src/cli/commands/milestone-tools.ts` following the same pattern:

Register a `milestone` subcommand group under `tools`:

**`megazord.mjs tools milestone create --version "{v}" --name "{name}" --phases "1,2,3"`**
- Call `createMilestone(planningDir, version, name, phases)`
- Output JSON result

**`megazord.mjs tools milestone archive --version "{v}"`**
- Call `archiveMilestone(planningDir, version)`
- Output JSON result

**`megazord.mjs tools milestone audit --phases "1,2,3"`**
- Call `checkMilestoneAudit(planningDir, phases)`
- Output JSON result

Register both command groups in `src/cli/index.ts`:
- Import `registerRoadmapCommands` from `./commands/roadmap-tools.ts`
- Import `registerMilestoneCommands` from `./commands/milestone-tools.ts`
- Call both registration functions with the `tools` parent command (same as existing `registerPlanCommands`, `registerStateCommands`)

The `planningDir` for all commands should be resolved the same way as existing commands (`.planning/` in cwd or detect from git root).
  </action>
  <verify>
- `src/cli/commands/roadmap-tools.ts` exists with 5 commands (list, add-phase, remove-phase, insert-phase, check-gate)
- `src/cli/commands/milestone-tools.ts` exists with 3 commands (create, archive, audit)
- Both files export a `register*Commands` function
- Both are imported and registered in `src/cli/index.ts`
- All commands output JSON via `JSON.stringify(result, null, 2)`
- All commands have try/catch error handling
- `bun run build` compiles without errors
  </verify>
  <done>CLI tools expose all roadmap and milestone operations as JSON-output commands under `megazord.mjs tools roadmap` and `megazord.mjs tools milestone`, registered in the CLI alongside existing plan and state tools. Build passes.</done>
</task>

</tasks>

<verification>
- `src/lib/roadmap.ts` and `src/lib/milestone.ts` exist with all exported functions
- `src/cli/commands/roadmap-tools.ts` and `src/cli/commands/milestone-tools.ts` exist and are registered
- `bun run build` passes
- All CLI commands produce JSON output
- Phase add/remove/insert handle edge cases (completed phases, decimal collisions)
- Verification gate check parses VERIFICATION.md status correctly
</verification>

<success_criteria>
- Library functions are tested via CLI: `node bin/megazord.mjs tools roadmap list` returns phase listing
- Phase management commands modify ROADMAP.md correctly
- Milestone commands handle archive with file copying and git tagging
- All commands follow existing CLI patterns (JSON output, error handling)
</success_criteria>

<output>
After completion, create `.planning/phases/08-brownfield-support-and-project-lifecycle/08-02-SUMMARY.md`
</output>
