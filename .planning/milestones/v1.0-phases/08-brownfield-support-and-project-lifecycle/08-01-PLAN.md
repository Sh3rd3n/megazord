---
phase: 08-brownfield-support-and-project-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/mz-mapper.md
  - skills/map/SKILL.md
  - skills/map/mapper.md
  - commands/map.md
autonomous: true
requirements:
  - PROJ-10

must_haves:
  truths:
    - "Running /mz:map spawns parallel mapper agents that analyze the codebase"
    - "Running /mz:map architecture runs only the architecture mapper agent"
    - "Map output produces separate documents per area in .planning/codebase/"
    - "Re-mapping an existing analysis offers the user refresh/update/skip options"
    - "A synthesis agent produces SUMMARY.md after all mappers complete"
  artifacts:
    - path: "agents/mz-mapper.md"
      provides: "Codebase mapper agent definition"
      min_lines: 80
    - path: "skills/map/SKILL.md"
      provides: "Map skill orchestrator replacing stub"
      min_lines: 150
    - path: "skills/map/mapper.md"
      provides: "Mapper spawning patterns reference"
      min_lines: 40
    - path: "commands/map.md"
      provides: "Autocomplete proxy for /mz:map"
  key_links:
    - from: "skills/map/SKILL.md"
      to: "agents/mz-mapper.md"
      via: "Read + inline embed in Task prompt"
      pattern: "agents/mz-mapper\\.md"
    - from: "skills/map/SKILL.md"
      to: ".planning/codebase/"
      via: "Agents write documents directly to this directory"
      pattern: "\\.planning/codebase/"
---

<objective>
Create the /mz:map codebase analysis skill with parallel mapper agents that produce structured documents about an existing codebase, enabling brownfield project onboarding.

Purpose: Allow Megazord to work with existing codebases by analyzing architecture, tech stack, code quality, and concerns into structured documents that inform planning.
Output: Mapper agent definition, /mz:map orchestrator skill, mapper reference file, autocomplete proxy.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-brownfield-support-and-project-lifecycle/08-RESEARCH.md
@.planning/phases/08-brownfield-support-and-project-lifecycle/08-CONTEXT.md

# Prior patterns to follow:
@agents/mz-researcher.md
@skills/plan/SKILL.md
@skills/plan/agents.md
@skills/verify/verifier.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mapper agent definition and spawning reference</name>
  <files>agents/mz-mapper.md, skills/map/mapper.md</files>
  <action>
Create `agents/mz-mapper.md` -- the codebase mapper agent definition. Follow the exact pattern established by `agents/mz-researcher.md` (role, input, output, rules sections).

The mapper agent receives a focus area and analyzes the codebase to produce structured documents. Define 4 focus areas producing 7 documents:

| Focus | Documents |
|-------|-----------|
| tech | STACK.md, INTEGRATIONS.md |
| architecture | ARCHITECTURE.md, STRUCTURE.md |
| quality | CONVENTIONS.md, TESTING.md |
| concerns | CONCERNS.md |

Plus a special "synthesis" focus that reads all 7 docs and produces SUMMARY.md.

Agent content must include:
- Role description: codebase analyzer that writes documents directly to `.planning/codebase/`
- Input specification: focus area, output directory, project root path
- Output format: structured markdown documents with frontmatter (area, date, project)
- Exclusion list: `node_modules/`, `.git/`, `dist/`, `build/`, `.planning/`, `coverage/`, `.next/`, `.cache/`
- Document templates for each focus area (what sections to include, what to analyze)
- Rules: write documents directly (orchestrator does NOT read them back), return only file path and line count confirmation
- Secret scanning warning: never include API keys, tokens, credentials found in config files or .env examples

Create `skills/map/mapper.md` -- spawning patterns reference (same pattern as `skills/plan/agents.md` and `skills/verify/verifier.md`). Include:
- Agent file location: `{plugin_path}/agents/mz-mapper.md`
- Spawning pattern: `subagent_type="general-purpose"` with inline embedding
- Focus parameter mapping (tech, architecture/arch, quality/conventions, concerns)
- Parallel spawning pattern (one Task per focus area)
- Synthesis agent spawning (after all 4 complete)
- Critical @file warning (same as in agents.md)
  </action>
  <verify>
- `agents/mz-mapper.md` exists and has 80+ lines
- `skills/map/mapper.md` exists and has 40+ lines
- Agent definition includes all 4 focus areas with document mappings
- Exclusion list is present
- Secret scanning warning is present
  </verify>
  <done>Mapper agent definition covers all 4 focus areas (7 documents + synthesis), includes exclusion list and secret scanning rules, and spawning reference documents the parallel execution pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create /mz:map orchestrator skill and autocomplete proxy</name>
  <files>skills/map/SKILL.md, commands/map.md</files>
  <action>
Replace the existing `/mz:map` stub in `skills/map/SKILL.md` with the full orchestrator skill. Follow the exact pattern from `skills/plan/SKILL.md` (banner, load context, spawn agents, handle results).

The skill must implement these steps:

**Step 1: Display Banner** -- `MEGAZORD > MAP` using design system.

**Step 2: Load Context** -- Read `megazord.config.json`. If missing, error and stop. Resolve plugin path (same pattern as /mz:plan Step 2). Parse arguments:
- Optional focus parameter: `/mz:map architecture`, `/mz:map tech`, etc.
- Map focus aliases: `arch` -> `architecture`, `conventions` -> `quality`
- Default (no argument): run all 4 areas

**Step 3: Check Existing Map** -- Check if `.planning/codebase/` directory exists with documents.
- If exists: offer 3 options via AskUserQuestion (header: "Remap", under 12 chars):
  1. "Refresh" -- delete existing, remap all
  2. "Update" -- keep existing, remap specified areas only
  3. "Skip" -- use existing map as-is (exit)
- If focus parameter was given + existing docs exist: offer "Update this area" / "Skip"
- If no existing map: proceed to mapping

**Step 4: Create Output Directory** -- `mkdir -p .planning/codebase/`

**Step 5: Spawn Mapper Agents** -- For each selected focus area:
1. Read `{plugin_path}/agents/mz-mapper.md` content (once, reuse for all spawns)
2. Spawn one Task per focus area, all in parallel (or just the focused one if a focus parameter was given):
   - `subagent_type="general-purpose"`
   - `description="Map codebase: {focus}"`
   - Prompt includes agent definition inline, focus area, output directory, exclusion list
3. Display progress: `â—† Mapping {focus}...` for each active agent
4. Wait for all agents to complete
5. Verify output files exist (check file presence via Bash `wc -l`, NOT reading content)

**Step 6: Synthesis (optional)** -- Only when ALL 4 areas were mapped (not on focused runs):
1. Spawn synthesis agent with the "synthesis" focus
2. This agent reads all 7 documents and produces `SUMMARY.md`
3. Wait for completion, verify SUMMARY.md exists

**Step 7: Display Results** -- Action box showing:
- Documents produced (file name + line count)
- Areas mapped
- Next Up: `/mz:plan` to create roadmap from analysis

**Important patterns:**
- Orchestrator NEVER reads the content of produced map documents (preserves context budget)
- All agent spawning follows the inline embedding pattern (read agent file, embed in Task prompt)
- Use `{plugin_path}` resolution from config (same as /mz:plan)
- Set `disable-model-invocation: false` in frontmatter (replacing stub's `true`)
- Reference `@skills/init/design-system.md` for visual formatting
- Reference `@skills/map/mapper.md` for spawning patterns

Create `commands/map.md` -- autocomplete proxy with frontmatter:
```yaml
---
name: map
description: Analyze existing codebase for brownfield project support
---
Invoke the mz:map skill.
```
  </action>
  <verify>
- `skills/map/SKILL.md` exists with 150+ lines
- `skills/map/SKILL.md` has `disable-model-invocation: false` in frontmatter
- `commands/map.md` exists
- SKILL.md references design-system.md and mapper.md
- SKILL.md includes all 7 steps (banner, context, check existing, mkdir, spawn, synthesis, results)
- Re-mapping logic with 3 options is present
- Focus parameter parsing is present
- Orchestrator does NOT read map document content (only checks existence/line count)
  </verify>
  <done>/mz:map stub replaced with full orchestrator skill that spawns parallel mapper agents, supports focus parameter filtering, handles re-mapping with 3 options, produces 7 documents + SUMMARY.md, and autocomplete proxy is created</done>
</task>

</tasks>

<verification>
- `agents/mz-mapper.md` exists with complete agent definition (80+ lines)
- `skills/map/SKILL.md` is a full orchestrator (not stub), 150+ lines, disable-model-invocation: false
- `skills/map/mapper.md` exists with spawning patterns (40+ lines)
- `commands/map.md` exists as autocomplete proxy
- Mapper agent covers 4 focus areas producing 7 documents
- Skill supports focus parameter (`/mz:map architecture`)
- Skill supports re-mapping (refresh/update/skip)
- Orchestrator never reads map document content
</verification>

<success_criteria>
- /mz:map skill is functional (no longer a stub)
- Mapper agent definition is complete with all focus areas, exclusion list, and templates
- Parallel spawning pattern is documented
- Focus parameter filtering works
- Re-mapping behavior handles existing analysis
</success_criteria>

<output>
After completion, create `.planning/phases/08-brownfield-support-and-project-lifecycle/08-01-SUMMARY.md`
</output>
