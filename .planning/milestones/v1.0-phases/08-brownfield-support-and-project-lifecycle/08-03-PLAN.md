---
phase: 08-brownfield-support-and-project-lifecycle
plan: 03
type: execute
wave: 2
depends_on:
  - "08-02"
files_modified:
  - skills/plan/SKILL.md
  - skills/verify/SKILL.md
  - skills/help/SKILL.md
autonomous: true
requirements:
  - PROJ-09
  - PROJ-10

must_haves:
  truths:
    - "/mz:plan checks for codebase map and suggests /mz:map when existing code is detected but no map exists"
    - "/mz:plan exposes phase management subcommands (add-phase, remove-phase, insert-phase)"
    - "/mz:plan enforces verification gate: warns if previous phase lacks passing VERIFICATION.md"
    - "/mz:verify --milestone audits all phases in a milestone and produces audit report"
    - "/mz:help shows /mz:map as Available (not Coming soon) and lists all lifecycle commands"
    - "Phase transitions are manual: user decides when to start next phase"
  artifacts:
    - path: "skills/plan/SKILL.md"
      provides: "Extended plan skill with brownfield integration, phase management, and verification gate"
      min_lines: 300
    - path: "skills/verify/SKILL.md"
      provides: "Extended verify skill with --milestone audit mode"
      min_lines: 260
    - path: "skills/help/SKILL.md"
      provides: "Updated help with /mz:map Available, lifecycle commands, Phase 8 of 8"
      min_lines: 60
  key_links:
    - from: "skills/plan/SKILL.md"
      to: ".planning/codebase/SUMMARY.md"
      via: "Check for codebase map, embed summary in roadmapper prompt"
      pattern: "\\.planning/codebase"
    - from: "skills/plan/SKILL.md"
      to: "megazord.mjs tools roadmap"
      via: "CLI tool invocation for phase management"
      pattern: "tools roadmap"
    - from: "skills/verify/SKILL.md"
      to: "megazord.mjs tools milestone audit"
      via: "CLI tool invocation for milestone audit"
      pattern: "tools milestone"
---

<objective>
Integrate lifecycle management into existing skills: extend /mz:plan with brownfield codebase map integration, phase management subcommands, and verification gate enforcement; extend /mz:verify with --milestone audit mode; update /mz:help to reflect final state.

Purpose: Wire the lifecycle infrastructure (from Plan 08-02) and codebase mapping (from Plan 08-01) into the user-facing skill layer, completing the full project lifecycle.
Output: Updated plan, verify, and help skills.
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-brownfield-support-and-project-lifecycle/08-RESEARCH.md
@.planning/phases/08-brownfield-support-and-project-lifecycle/08-CONTEXT.md

# Files being modified (read these first):
@skills/plan/SKILL.md
@skills/verify/SKILL.md
@skills/help/SKILL.md

# Prior plan summaries for context on what infrastructure exists:
@.planning/phases/08-brownfield-support-and-project-lifecycle/08-01-SUMMARY.md
@.planning/phases/08-brownfield-support-and-project-lifecycle/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend /mz:plan with brownfield integration, phase management, and verification gate</name>
  <files>skills/plan/SKILL.md</files>
  <action>
Read the current `skills/plan/SKILL.md` and extend it with three new capabilities. Keep ALL existing content intact -- these are additive changes.

**Extension 1: Brownfield Codebase Map Integration (add to Step 2)**

After loading config and before determining the target phase, add a brownfield detection check:

1. Check if `.planning/codebase/SUMMARY.md` exists
2. If it exists: read the summary content and store for later embedding in the planner prompt
3. If it does NOT exist but existing code is detected (check for `package.json`, `src/`, `lib/`, `app/`, `Cargo.toml`, `go.mod`, `requirements.txt`, `pyproject.toml`, or `pom.xml` in the project root):
   Display a soft warning:
   ```
   > Brownfield
     ! Existing code detected but no codebase map found.
     Run /mz:map first for better roadmap quality, or continue without.
   ```
   Use AskUserQuestion (header: "Brownfield", 10 chars):
   - "Continue without map"
   - "Run /mz:map first" (exit with suggestion)

4. When the planner agent is spawned (Step 6), if codebase summary was loaded, include it as:
   ```
   <codebase_context>
   {SUMMARY.md content}
   </codebase_context>
   ```
   This gives the planner awareness of existing architecture when creating brownfield roadmaps.

**Extension 2: Phase Management Subcommands (add after Step 3)**

Parse the user's message for phase management subcommands:
- `/mz:plan add-phase {description}` -- Add a new phase
- `/mz:plan remove-phase {N}` -- Remove a phase
- `/mz:plan insert-phase {N} {description}` -- Insert after phase N

When a subcommand is detected, handle it directly without spawning researcher/planner agents:

For `add-phase`:
1. Run: `node {plugin_path}/bin/megazord.mjs tools roadmap add-phase --description "{description}"`
2. Parse JSON result
3. Display success: `> Phase {N} added: {description}`
4. Exit (do not proceed to regular planning)

For `remove-phase`:
1. Validate phase number
2. Run: `node {plugin_path}/bin/megazord.mjs tools roadmap remove-phase --phase {N}`
3. If error (completed/in-progress): display error and exit
4. Display success with renumbering info
5. Exit

For `insert-phase`:
1. Parse the after-phase number and description
2. Run: `node {plugin_path}/bin/megazord.mjs tools roadmap insert-phase --after {N} --description "{description}"`
3. Display success with the decimal phase number
4. Exit

**Extension 3: Verification Gate Enforcement (add to Step 3)**

After determining the target phase (and BEFORE any research/planning):

1. If the target phase number is > 1: check the previous phase's verification status:
   ```bash
   node {plugin_path}/bin/megazord.mjs tools roadmap check-gate --phase {N-1}
   ```
2. Parse the JSON result
3. If verification is not passed:
   Display a strong warning (not blocking -- user has final authority):
   ```
   > Verification Gate
     ! Phase {N-1} has not passed verification.
     Run /mz:verify {N-1} before planning Phase {N}.
   ```
   Use AskUserQuestion (header: "Gate", 4 chars):
   - "Continue anyway" (proceed with planning)
   - "Run /mz:verify first" (exit with suggestion)
4. If verification passed: display confirmation:
   ```
   > Verification Gate
     âœ“ Phase {N-1} verified
   ```

**Important:** Phase transitions remain manual (locked decision). The gate is a warning, not a hard block. The user always decides.
  </action>
  <verify>
- `skills/plan/SKILL.md` exists with 300+ lines
- Brownfield detection check is present (checks for .planning/codebase/SUMMARY.md)
- Soft warning for existing code without map is present
- Codebase context embedding in planner prompt is present
- Phase management subcommands are handled (add-phase, remove-phase, insert-phase)
- Verification gate check is present (checks previous phase)
- Gate is advisory (warning, not blocking)
- All existing plan skill functionality is preserved
  </verify>
  <done>/mz:plan extended with brownfield integration (codebase map awareness), phase management subcommands (add/remove/insert), and verification gate enforcement (advisory warning before planning next phase). All existing functionality preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Extend /mz:verify with milestone audit and update help</name>
  <files>skills/verify/SKILL.md, skills/help/SKILL.md</files>
  <action>
**Part A: Extend /mz:verify with --milestone mode**

Read current `skills/verify/SKILL.md` and add milestone audit support. Keep ALL existing content intact.

Add `--milestone {version}` argument parsing in Step 2 (alongside existing `{phase_num}` and `--partial`).

When `--milestone` is provided, the skill enters **milestone audit mode** (separate from phase verification):

**Milestone Audit Flow (insert as alternative path after Step 3):**

1. Display: `> Milestone Audit: {version}`
2. Determine which phases belong to this milestone:
   - If a MILESTONE.md exists in `.planning/` with the version, read the phases list from it
   - If no MILESTONE.md exists, treat all completed phases as the milestone scope
3. For each phase in the milestone:
   Run: `node {plugin_path}/bin/megazord.mjs tools milestone audit --phases "{comma-separated phase numbers}"`
4. Parse the JSON audit result
5. Display audit results:

If all phases pass:
```
+===============================================+
|  Milestone {version} Audit: PASSED           |
+-----------------------------------------------+
|  Phases verified: {N}/{N}                     |
|  All verification gates passed.               |
+===============================================+
```
Suggest: `/mz:plan` to complete the milestone (archive + tag).

If some phases fail:
```
+===============================================+
|  Milestone {version} Audit: GAPS FOUND       |
+-----------------------------------------------+
|  Phases verified: {passed}/{total}            |
|                                               |
|  Failed:                                      |
|  - Phase {N}: {reason}                        |
|  - Phase {M}: No VERIFICATION.md             |
+===============================================+
```
Suggest: `/mz:verify {N}` for each failed phase.

6. Write `MILESTONE-AUDIT.md` in `.planning/` with:
   - Version, date, status (passed/gaps_found)
   - Per-phase verification status
   - Aggregate statistics

The regular phase verification flow (Steps 3-7) remains unchanged and is the default when `--milestone` is NOT provided.

**Part B: Update /mz:help**

Update `skills/help/SKILL.md`:

1. Move `/mz:map` from "Coming soon" to "Available" in the table. Update its description to: "Analyze existing codebase for brownfield support"
2. All 14 skills should now be "Available" (none "Coming soon")
3. Add usage examples for /mz:map:
   ```
   /mz:map              Analyze full codebase (4 areas)
   /mz:map architecture  Map architecture only
   /mz:map tech          Map tech stack only
   ```
4. Add usage examples for new /mz:plan subcommands:
   ```
   /mz:plan add-phase "New feature"    Add a phase to the roadmap
   /mz:plan remove-phase 9             Remove an unstarted phase
   /mz:plan insert-phase 6 "Hotfix"    Insert phase after phase 6
   ```
5. Add usage example for milestone audit:
   ```
   /mz:verify --milestone v1.0   Audit all phases for milestone v1.0
   ```
6. Update Phase line: `Phase: 8 of 8 (Brownfield Support and Project Lifecycle)`
7. Remove the "Skills marked 'Coming soon'" note since all skills are now available
  </action>
  <verify>
- `skills/verify/SKILL.md` exists with 260+ lines
- `--milestone` argument is parsed
- Milestone audit flow produces MILESTONE-AUDIT.md
- Milestone audit uses CLI tool (`tools milestone audit`)
- Regular phase verification is unchanged
- `skills/help/SKILL.md` shows 14 Available skills, 0 Coming soon
- /mz:map is listed as Available
- Phase management subcommand usage examples are present
- Milestone audit usage example is present
- Phase line shows 8 of 8
  </verify>
  <done>/mz:verify extended with --milestone audit mode that checks all phases in a milestone and produces MILESTONE-AUDIT.md. /mz:help updated to show all 14 skills as Available with new lifecycle command examples. Phase 8 of 8 reflected.</done>
</task>

</tasks>

<verification>
- `skills/plan/SKILL.md` has brownfield detection, phase management subcommands, and verification gate
- `skills/verify/SKILL.md` has --milestone audit mode
- `skills/help/SKILL.md` shows 14 Available, 0 Coming soon, Phase 8 of 8
- All existing skill functionality is preserved (no regressions)
- Phase transitions remain manual (locked decision honored)
- Verification gate is advisory (locked decision honored)
</verification>

<success_criteria>
- /mz:plan detects existing codebases and suggests /mz:map
- /mz:plan handles add-phase, remove-phase, insert-phase subcommands
- /mz:plan warns about verification gate before planning next phase
- /mz:verify --milestone produces audit report
- /mz:help reflects complete feature set (14 Available skills)
- All locked decisions from CONTEXT.md are honored
</success_criteria>

<output>
After completion, create `.planning/phases/08-brownfield-support-and-project-lifecycle/08-03-SUMMARY.md`
</output>
