---
phase: 11-milestone-lifecycle-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/lifecycle/SKILL.md
  - commands/lifecycle.md
  - skills/help/SKILL.md
autonomous: true
requirements: [PROJ-09]

must_haves:
  truths:
    - "User can invoke /mz:lifecycle and see a milestone status summary before any destructive action"
    - "When audit finds gaps, the skill proposes gap-closure phases instead of proceeding to archive"
    - "User can skip audit with --skip-audit flag for informal projects"
    - "After audit passes, user can archive the current milestone through the skill flow"
    - "Deferred items from all phase CONTEXT.md files are collected and presented for user selection"
    - "User confirms or modifies the suggested next version number before milestone creation"
    - "After archive, the skill resets state files and suggests next steps"
    - "/mz:lifecycle appears in /mz:help and autocomplete"
  artifacts:
    - path: "skills/lifecycle/SKILL.md"
      provides: "Unified milestone lifecycle orchestration skill"
      min_lines: 250
    - path: "commands/lifecycle.md"
      provides: "Autocomplete proxy for /mz:lifecycle"
      min_lines: 3
    - path: "skills/help/SKILL.md"
      provides: "Updated help listing with /mz:lifecycle"
      contains: "/mz:lifecycle"
  key_links:
    - from: "skills/lifecycle/SKILL.md"
      to: "tools milestone audit"
      via: "CLI tool invocation for milestone audit"
      pattern: "tools milestone audit"
    - from: "skills/lifecycle/SKILL.md"
      to: "tools milestone archive"
      via: "CLI tool invocation for milestone archive"
      pattern: "tools milestone archive"
    - from: "skills/lifecycle/SKILL.md"
      to: "tools milestone create"
      via: "CLI tool invocation for new milestone creation"
      pattern: "tools milestone create"
    - from: "skills/lifecycle/SKILL.md"
      to: "tools roadmap add-phase"
      via: "CLI tool invocation for gap-closure phase proposals"
      pattern: "tools roadmap add-phase"
---

<objective>
Create the `/mz:lifecycle` skill that guides users through the full milestone lifecycle: audit, archive, deferred item collection, and next version preparation. Update help and autocomplete.

Purpose: Close the PROJ-09 gap -- users can complete the entire milestone lifecycle through a skill-level path without falling back to CLI commands.
Output: `skills/lifecycle/SKILL.md`, `commands/lifecycle.md`, updated `skills/help/SKILL.md`
</objective>

<execution_context>
@/Users/sh3rd3n/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sh3rd3n/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing skill patterns to follow
@skills/verify/SKILL.md
@skills/go/SKILL.md
@skills/init/design-system.md

# CLI tool interfaces (read for exact command signatures)
@src/lib/milestone.ts
@src/cli/commands/milestone-tools.ts

# Existing help and command proxy pattern
@skills/help/SKILL.md
@commands/verify.md

# Research (architecture recommendations, pitfalls, code examples)
@.planning/phases/11-milestone-lifecycle-completion/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /mz:lifecycle skill definition</name>
  <files>skills/lifecycle/SKILL.md</files>
  <action>
Create `skills/lifecycle/SKILL.md` following the established skill pattern (frontmatter with name/description/disable-model-invocation: false, step-by-step orchestration).

The skill orchestrates the full milestone lifecycle through these steps:

**Step 1: Display Banner**
Standard Megazord banner: `MEGAZORD > LIFECYCLE`

**Step 2: Load Context and Validate**
- Read `megazord.config.json` (error if missing, suggest `/mz:init`)
- Read `STATE.md` for current position
- Read `ROADMAP.md` for phase details
- Resolve `plugin_path` from config or fallback `~/.claude/plugins/mz`
- Parse arguments from user message: `--skip-audit` flag, `{version}` argument (optional, auto-detect from MILESTONE.md or suggest)

**Step 3: Milestone Status Summary** (LOCKED decision: always show before proceeding)
- Run `node {plugin_path}/bin/megazord.mjs tools roadmap list` to get all phases
- Run `node {plugin_path}/bin/megazord.mjs tools progress` for overall progress
- Display a summary box showing: milestone version, total phases, completed phases, progress percentage, any phases with issues
- If no version argument provided, detect from `.planning/MILESTONE.md` if it exists, otherwise prompt user

**Step 4: Audit (or skip)**
- If `--skip-audit` was provided: display note "Skipping audit (--skip-audit)." and jump to Step 6
- Check for existing `MILESTONE-AUDIT.md` in `.planning/`. If found and recent (check date in file), offer to reuse: "Existing audit from {date} found. Reuse? (yes/re-run)"
- If no existing audit or user wants re-run: run `node {plugin_path}/bin/megazord.mjs tools milestone audit --phases "{comma-separated}"` using phase numbers from MILESTONE.md or all completed phases
- Parse JSON result

**Step 5: Handle Audit Result**
- **If all_passed:** Display passed box, proceed to Step 6
- **If gaps found:** Display gaps clearly (per-phase status table). Then propose gap-closure phases:
  - Group gaps by nature (missing verification, failed verification, etc.)
  - For each gap group, suggest a new phase using `tools roadmap add-phase --description "{gap description}"`
  - Display: "Propose adding {N} gap-closure phase(s) to address these gaps. After completing them, re-run `/mz:lifecycle` to re-audit."
  - Ask user to confirm adding the proposed phases
  - If confirmed, add phases via CLI tool, display next steps: "Run `/mz:plan` for the new phase(s), then `/mz:go` to execute, then `/mz:lifecycle` again."
  - EXIT (do not proceed to archive when gaps exist)

**Step 6: Confirm Archive**
Show what will be archived:
- ROADMAP.md -> milestones/{version}-ROADMAP.md
- REQUIREMENTS.md -> milestones/{version}-REQUIREMENTS.md
- phases/ -> milestones/{version}-phases/
- STATE.md -> milestones/{version}-STATE.md (skill supplement)
- Git tag: milestone/{version}
- Check for duplicate archive (milestones/{version}-ROADMAP.md exists -> warn)
Ask: "Proceed with archive? (yes/no)"

**Step 7: Execute Archive**
- Run `node {plugin_path}/bin/megazord.mjs tools milestone archive --version "{version}"`
- Additionally archive STATE.md manually (read STATE.md, write to `.planning/milestones/{version}-STATE.md`) since archiveMilestone() does not archive STATE.md
- Update MILESTONE.md status from "active" to "archived" (read file, replace `status: active` with `status: archived`, write back)
- Display archive confirmation with list of archived files

**Step 8: Collect Deferred Items** (LOCKED decision: collect from CONTEXT.md, user selects)
- Scan all `.planning/phases/*/NN-CONTEXT.md` files
- For each: extract text between `<deferred>` and `</deferred>` tags
- Parse bullet points (lines starting with "- ")
- Skip entries that are just "None" or contain only "None"
- Strip phase references from items (present clean action items, not "Phase 6 (Agent Teams Integration)")
- Present numbered list to user: "Select which deferred items to carry forward as requirements for the next milestone (comma-separated numbers, or 'all', or 'none'):"
- Collect user selection

**Step 9: Prepare Next Version** (LOCKED decisions: semver bump suggestion, user confirms; config inherited as-is)
- Suggest next version: parse current version string, suggest semver minor bump (e.g., v1.0 -> v2.0 for major milestone, or v1.1 for minor). Default: bump major.
- Ask user: "Next milestone version? (suggested: {suggestion}, or type a version):"
- Ask user: "Milestone name? (e.g., 'Second Release'):"
- Confirm version and name

**Step 10: Reset State Files**
- Create fresh ROADMAP.md skeleton:
  ```
  # Roadmap: {project_name}

  ## Overview

  {project_name} - {next_version}

  ## Phases

  (No phases planned yet. Run `/mz:plan` to create a roadmap.)

  ## Progress

  | Phase | Plans Complete | Status | Completed |
  |-------|----------------|--------|-----------|
  ```
- Create fresh STATE.md:
  ```
  # Project State

  ## Project Reference

  See: .planning/PROJECT.md

  **Core value:** {from archived STATE.md}
  **Current focus:** {next_version} - Ready for planning

  ## Current Position

  Phase: 0 of 0
  Plan: 0 of 0
  Status: Ready for planning
  Last activity: {today} -- Milestone {old_version} archived, starting {next_version}

  Progress: [░░░░░░░░░░░░░░░░░░░░░] 0%

  ## Performance Metrics

  (New milestone -- no metrics yet)

  ## Accumulated Context

  ### Decisions

  (None yet)

  ### Pending Todos

  (None yet)

  ### Blockers/Concerns

  (None)

  ## Session Continuity

  Last session: {today}
  Stopped at: Milestone {next_version} initialized
  Resume file: None
  Stash ref: None
  Last error: None
  ```
- Create fresh REQUIREMENTS.md with selected deferred items as initial requirements (if any):
  ```
  # Requirements: {project_name} {next_version}

  ## Requirements

  | ID | Description | Priority | Status |
  |----|-------------|----------|--------|
  {For each selected deferred item: | NEW-{NN} | {item text} | Medium | Pending |}

  (Requirements will be refined during `/mz:plan` roadmap creation.)
  ```
- Create new MILESTONE.md via CLI: `tools milestone create --version "{next_version}" --name "{name}" --phases ""`  (empty phases, to be populated by /mz:plan)

**Step 11: Display Completion**
```
+===============================================+
|  Milestone {old_version} Archived            |
+===============================================+
|  Archived: {N} files to milestones/          |
|  Git tag: milestone/{old_version}            |
|  Deferred items carried: {M} of {total}      |
|  Next milestone: {next_version} - {name}     |
+===============================================+

> Next Up
**Ready for {next_version}.** Create the roadmap and start planning.
`/mz:plan`
```

**Error Handling table:**

| Error | Step | Action |
|-------|------|--------|
| Config missing | Step 2 | Error box, suggest `/mz:init`. Stop. |
| ROADMAP.md missing | Step 2 | Error box, suggest `/mz:plan`. Stop. |
| No completed phases | Step 3 | Error: "No completed phases found. Complete at least one phase before running lifecycle." Stop. |
| Archive already exists | Step 6 | Warning: "Milestone {version} appears already archived." Ask to proceed or abort. |
| Archive CLI fails | Step 7 | Display error, suggest manual recovery. Stop. |
| No CONTEXT.md files found | Step 8 | Skip deferred items: "No deferred items found." |

**Notes section:**
- All CLI commands use the resolved `{plugin_path}` pattern (from config or fallback)
- ALWAYS use bun/bunx for JavaScript/TypeScript operations (never npm/npx)
- The skill does NOT auto-invoke `/mz:plan` after completion -- it suggests it as the next step (matches the verify pattern)
- Config (megazord.config.json) is inherited as-is per user decision -- no config review prompt

Reference `@skills/init/design-system.md` for visual formatting (banner, action boxes, status symbols).
Reference `@skills/verify/SKILL.md` for the established skill orchestration pattern (load config, resolve plugin_path, call CLI tools, display results).
  </action>
  <verify>
- `skills/lifecycle/SKILL.md` exists and has valid frontmatter (name, description, disable-model-invocation)
- File contains all 11 steps
- File references all required CLI tools: milestone audit, milestone archive, milestone create, roadmap list, roadmap add-phase
- File handles --skip-audit flag
- File includes deferred items collection from CONTEXT.md files
- File includes version suggestion with user confirmation
- File includes state reset (ROADMAP.md, STATE.md, REQUIREMENTS.md, MILESTONE.md)
- File includes error handling table
- File references design-system.md for formatting
  </verify>
  <done>
A complete `/mz:lifecycle` skill definition exists at `skills/lifecycle/SKILL.md` that orchestrates audit -> gap-closure proposal -> archive -> deferred items -> state reset -> next version, following the established skill pattern and referencing all existing CLI tools.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create autocomplete proxy and update help skill</name>
  <files>commands/lifecycle.md, skills/help/SKILL.md</files>
  <action>
**Autocomplete proxy:**
Create `commands/lifecycle.md` following the exact pattern of existing proxies (e.g., `commands/verify.md`):
```
---
description: Complete milestone lifecycle: audit, archive, and next version
---

Invoke the mz:lifecycle skill and follow it exactly as presented to you
```

**Help skill update:**
Edit `skills/help/SKILL.md`:
1. Add `/mz:lifecycle` row to the Available Skills table:
   `| /mz:lifecycle | Complete milestone lifecycle (audit, archive, next version) | Available |`
   Place it after `/mz:verify` in the table (verification -> lifecycle is the natural flow).

2. Add usage examples to the Usage section:
   ```
   /mz:lifecycle          Complete current milestone lifecycle
   /mz:lifecycle v1.0     Archive milestone v1.0 specifically
   /mz:lifecycle --skip-audit  Skip audit and proceed to archive
   ```

3. Update the About section: change "Phase: 8 of 8" to "Phase: 11 of 11 (Milestone Lifecycle Completion)" and the skill count if mentioned.
  </action>
  <verify>
- `commands/lifecycle.md` exists with frontmatter containing `description` field
- `skills/help/SKILL.md` contains `/mz:lifecycle` in the Available Skills table
- Help skill has usage examples for `/mz:lifecycle`
- About section phase number is updated
  </verify>
  <done>
`/mz:lifecycle` is discoverable via autocomplete (proxy file exists) and listed in `/mz:help` with description and usage examples.
  </done>
</task>

</tasks>

<verification>
- Run `ls skills/lifecycle/SKILL.md commands/lifecycle.md` -- both exist
- Check `skills/help/SKILL.md` contains "lifecycle" string
- Verify SKILL.md references all CLI tools: `milestone audit`, `milestone archive`, `milestone create`, `roadmap list`, `roadmap add-phase`
- Verify SKILL.md handles all user decisions: --skip-audit, deferred items selection, version suggestion, config inherited, gap-closure proposal
- Count steps in SKILL.md -- should be 11 steps
</verification>

<success_criteria>
1. `skills/lifecycle/SKILL.md` is a complete skill definition (250+ lines) that orchestrates the full milestone lifecycle
2. `commands/lifecycle.md` exists as an autocomplete proxy following the established pattern
3. `/mz:lifecycle` appears in the help skill's Available Skills table with description and usage examples
4. All locked user decisions are honored: milestone summary shown before archive, deferred items collected from CONTEXT.md with user selection, semver version suggestion with user confirmation, gap-closure phases proposed when audit finds gaps, --skip-audit supported, config inherited as-is
5. All CLI tool invocations use the correct command signatures from milestone-tools.ts and roadmap-tools.ts
</success_criteria>

<output>
After completion, create `.planning/phases/11-milestone-lifecycle-completion/11-01-SUMMARY.md`
</output>
